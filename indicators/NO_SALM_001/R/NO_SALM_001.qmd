---
title: "<i>Salmo salar</i> (Atlantic salmon)"
subtitle: |
  [NO_SALM_001] \
indicatorID: 
  - NO_SALM_001
indicatorName: 
  - <i>Salmo salar</i> (Atlantic salmon)
country: Norway
continent: Europe
ECT: B1 - Compositional State Characteristics
Realm: 
  - Freshwater (F)
Biome: 
  - F1 Rivers and streams biome
Ecosystem: 
  - F1.3 Freeze-thaw streams
yearAdded: 2025
yearLastUpdate: 2025
status: complete
Version: "001.000"
VersionComment: First complete version
url: https://github.com/NINAnor/ecRxiv/tree/main/indicators/NO_SALM_001
Normalised: Yes
SpatialAggregationPathway: Scale - Transform - Truncate - Aggregate (length-weighted arithmetic mean)
format: 
  html:
    embed-resources: true
    code-fold: true
    toc: true
    toc-title: Contents
    toc-depth: 3
    smooth-scroll: true
execute: 
  cache: true
author:
  - name: Hanno Sandvik
    email: hanno.sandvik@nina.no
    affiliations:
      - id: myID
        name: Norwegian Institute for Nature Research
AuthorList: Sandvik, H.  
date: October 27, 2025
data_availability: gold
code_reproducibility: silver
open_science_badge: silver
callout-icon: false
lightbox: true
css: ../../../style.css
code-links:
      - text: Add a review
        icon: github
        href: https://github.com/NINAnor/ecRxiv
---

<!--# This is a template for how to document the indicator analyses. Make sure also to not change the order, or modify, the headers, unless you really need to. This is because it easier to read if all the indicators are presented using the same layout. If there is one header where you don't have anything to write, just leave the header as is, and don't write anything below it. If you are providing code, be careful to annotate and comment on every step in the analysis. Before starting it is recommended to fill in as much as you can in the metadata file. This file will populate the initial table in your output.-->

<!--# Load all you dependencies here -->

```{r setup}
#| include: false
#| cache: false
library(knitr)
library(tidyverse)
library(kableExtra)
library(here)
library(anybadger)
library(yaml)
library(tibble)
library(conflicted)
# weird workarounds for cache issues
conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::lag)
conflicts_prefer(dplyr::select)
pull<-dplyr::pull

knitr::opts_chunk$set(echo = TRUE)

library(foreign)
library(sf)
library(readxl)
library(httr)
library(jsonlite)
library(sp)
```

```{r source}
#| echo: false
#| cache: false
source(here::here("_common.R"))
```

```{r extractFromYML}
#| echo: false
#| cache: false
this_file <- get_file_info()

# Read the YAML front matter
lines <- readLines(this_file$path, warn = FALSE)
dash_lines <- which(trimws(lines) == "---")
yaml_block <- lines[(dash_lines[1] + 1):(dash_lines[2] - 1)]
yaml_data <- yaml::yaml.load(paste(yaml_block, collapse = "\n"))

# Robust flatten function
flatten_to_string <- function(x) {
  if (is.list(x)) {
    # recursively flatten any nested lists
    x <- unlist(x, recursive = TRUE)
  }
  # convert to single string
  paste(x, collapse = "; ")
}

# Apply to all YAML entries
yaml_data_flat <- lapply(yaml_data, flatten_to_string)

# Create tibble
meta <- tibble::enframe(yaml_data_flat, name = "Variable", value = "Value")

# Check structure
#str(meta)

st <- meta |>
  dplyr::filter(Variable == "status") |>
  pull(Value)
version <- meta |>
  dplyr::filter(Variable == "Version") |>
  pull(Value)
auth <- meta |>
  dplyr::filter(Variable == "AuthorList") |>
  pull(Value)
year <- meta |>
  dplyr::filter(Variable == "yearAdded") |>
  pull(Value)
id <- meta |>
  dplyr::filter(Variable == "indicatorID") |>
  pull(Value)
name <- meta |>
  dplyr::filter(Variable == "indicatorName") |>
  pull(Value)
url <- meta |>
  dplyr::filter(Variable == "url") |>
  pull(Value)
badges<-meta |> 
  dplyr::filter(Variable %in% c("data_availability",
         "code_reproducibility", "open_science_badge")) |> 
  pull(Value)

meta <- meta |>
  dplyr::mutate(Variable = dplyr::case_match(Variable,
    "indicatorID" ~ "Indicator ID" ,
    "indicatorName" ~ "Indicator Name",
    "continent" ~ "Continent",
    "country" ~ "Country",
    "ECT" ~ "Ecosystem Condition Typology Class",
    "yearAdded" ~ "Year added",
    "yearLastUpdate" ~ "Last update",
    "VersionComment" ~ "Version comment",
    "SpatialAggregationPathway" ~ "Spatial aggregation pathway",
    .default = Variable
  )) |>
  dplyr::filter(Variable != "authors")

```



<!--# The following parts are autogenerated. Do not edit. -->

::: {layout-ncol="5"}

```{r statusBadge}
#| echo: false
status_badge(as.character(st))
```

```{r versionBadge}
#| echo: false
version_badge(version_number = as.character(version[[1]]))
```

```{r dataBadge}
#| echo: false
data_badge(as.character(badges[[1]]))
```

```{r codeBadge}
#| echo: false
code_badge(as.character(badges[[2]]))
```

```{r openScienceBadge}
#| echo: false
open_science_badge(as.character(badges[[3]]))
```
::: 
 

> **Recommended citation**: `r paste(auth, " ", year, ". ", name, " (ID: ", id, ") ", "v. ", version, ". ecRxiv: ", url, sep="")`



::: {.callout-tip collapse="true"}
## Metadata
```{r tbl-meta2}
#| tbl-cap: 'Indicator metadata'
#| echo: false
#| warning: false
meta |>
  dplyr::filter(Variable %in% c(
    "Indicator ID",
    "Indicator Name",
    "Continent",
    "Country",
    "Ecosystem Condition Typology Class", 
    "Realm",
    "Biome",
    "Ecosystem",
    "Year added", 
    "Last update",
    "Version",
    "Version comment",
    "Normalised",
    "Spatial aggregation pathway")) |>   
  kable()

```
:::

::: {.callout-tip collapse="true"}

## Log

<!--# Update this logg with short messages for each update -->
- 28 Aug 2025 - Version 001.000 started: first complete version
- 27 Oct 2025 - Version 001.000 submitted to review
:::


<hr />

<!--# Document you work below.  -->

## 1. Summary

<!--# 
With a maximum of 300 words, describe the indicator in general terms as you would to a non-expert. Think of this as a kind of common language summary. Follow the four numbers sub-headers below. under point 2, it is possible under  include a bullet point list of the specific steps in the workflow. 
 -->

1. **Background and rationale**:
Atlantic salmon (*Salmo salar*) is a keystone species in Norwegian rivers. 
Salmons are andromous fish, meaning that they migrate between freshwater, where they spawn, and saltwater. 
Salmon stock size is thus affected by natural conditions and anthropogenic impacts both in freshwater and at sea. 
The most important negative impacts are salmon farming, climate change, hydromorphological changes, alien species, acid precipitation, and contaminants.
<!-- What does the metric represent? Why is this relevant for describing ecosystem condition in this ecosystem?
What are the main anthropogenic impact factors? -->
2. **Methods**:
Wild stocks of salmon in Norway are classified according to a so-called "[quality norm](#norm)", which evaluates the status of salmon stocks in two dimensions ([VRL 2011](#vrl11)), viz. population status and genetic integrity. 
The overall stock quality is determined by the poorest of the two dimensions. 
A comprehensive classification of salmon stocks is published every fifth year by the [Norwegian Scientific Advisory Committee for Atlantic Salmon](https://vitenskapsradet.no/). 
The indicator is defined in line with the quality norm and the published assessments, but it is turned into a continuous score using the approach defined by the [Water Framework Directive](#wfd). 
The workflow thus consists of the following steps:
    * Variables that are available on an annual basis are averaged for each accounting period.
    * Remaining variables are taken from the most recently published assessment.
    * Uncertain or missing values are filled in using a re-sampling procedure.
    * The underlying variables are transformed into continuous "normalised Ecological Quality Ratios" (nEQR) between 0 and 1 using the reference levels defined by the quality norm.
    * The population status for each river is calculated by an additive combination of the nEQR values for the attainment of the conservation limit and for the harvest potential.
    * The indicator value for each river is calculated by combining the nEQR values for population status and genetic integrity using the one-out--all-out principle.
    * The indicator values are aggregated spatially to obtain national or regional averages.
<!-- What kind of data is used? How is the data customized (modified, estimated, integrated) to fit its purpose as an indicator? -->
3. **Interpretation**:
An indicator value of 1 signifies a condition where the wild salmon stock has a productivity that corresponds to undisturbed conditions, where its at-sea survival ensures a normal harvest level, and where the stock is not genetically affected by escaped farmed salmons. 
Values decreasing toward zero reflect that at least one of these conditions is met to a lesser degree.
<!-- Add a very short description of how the indicator values should be interpreted. Here's an example for a bumblebee indicator: An indicator value of 1 signifies an intact bumblebee community. Values decreasing toward zero reflect negative ecological change, specifically the decline of species expected to be present. This metric does not account for potentially positive changes, such as increases in species' abundance or the arrival of new species. Tip: Add text on the line directly following the subheader, and don't introduce blank lines. This way the whole paragraph renders as a block quote. -->
4. **Results and development needs**:
The indicator is ready for use. 
Its values for 2024 mean that salmon stock quality is poor.
<!-- Briefly, what does the indicator say about the ecosystem condition. What is the current status of  the metric (can it be used or is it still in development), and what immediate tasks remain to improve the indicator or to make the indicator operational -->


## 2. About the underlying data

The [Norwegian Scientific Advisory Committee for Atlantic Salmon](https://vitenskapsradet.no/) (or **VRL**, an abbreviation of *Vitenskapelig råd for lakseforvaltning*) regularly evaluates the status of wild Atlantic salmon (*Salmo salar*, "salmon" hereafter) in Norway. 
Every year, VRL publishes reports detailing their evaluation (in Norwegian). 
Every fifth year, VRL publishes a comprehensive classification of salmon stocks, where the main stocks are assessed according to a so-called *quality norm* and many additional stocks according to a simplified procedure. 
The [quality norm](#norm) (Norw. *kvalitetsnorm*) is a regulation adopted by Royal Decree in 2013, whose full name translates as "quality norm for wild stocks of Atlantic salmon", and which "determines threshold values for the quality of wild salmon stocks based on the stocks' reproduction, harvest potential and genetic integrity" (Art.&nbsp;2).

The quality norm assigns the stock quality of wild salmon to five categories. 
It is estimated as the poorest category obtained by two criteria ([VRL 2011](#vrl11)): (1) a relative measure of the spawning stock size, and (2) its genetic integrity. 

(1) Relative spawning stock size, or the population status, is assessed in an additive manner using two subcriteria: (1a) attainment of the *conservation limit*, and (1b) *harvest potential*. 
The conservation limit (sensu [Forseth et al. 2013](#for13)) is the estimated cumulative biomass of spawning females under undisturbed conditions. 
The harvest potential is the harvested biomass relative to the one expected under undisturbed conditions.

(2) Genetic integrity is assessed qualitatively using up to four subcriteria. 
In practice, only one subcriterion is currently used, viz. the introgression of genes from farmed salmon.

The simplified procedure ([VRL 2017](#vrl17), [VRL 2018](#vrl18)) does not assess genetic integrity, and it uses three (rather than five) categories to describe population status.

<!--# Describe the data you have used in more detail, it's origin, biases, availability ect.-->

### 2.1 Spatial and temporal resolution and extent

The **spatial** resolution of this indicator is on the level of *river systems* (Norw. *vassdrag*), specifically their anadromous proportion (i.e., the part of a river system which is accessible to salmons).

The **temporal** resolution of the quality norm for salmon is *five years*. 
However, some of the components of the indicator are estimated and updated annually for large/important rivers systems. 
This applies to the attainment of the conservation limit and the harvest potential.

<!--# Describe the temporal and spatial resolution and extent of the data used -->

### 2.2 Sampling design

Most relevant salmon rivers are included in the dataset, i.e. all river systems in which significant salmon stocks spawn today or have spawned historically. 
The salmon rivers with the largest spawning stocks are assessed regularly using the methodology described in the quality norm (currently, *N* &approx; 180). 
Additional salmon rivers are assessed using a simplified procedure (*N* &approx; 260).
Some smaller salmon rivers, most of which have only few spawning individuals, are not included in the dataset.

<!-- How was the data sampled? Describe potential sampling biases -->

### 2.3 Original units

According to the quality norm, salmon stock quality is reported as a categorical score with five levels: "high", "good", "moderate", "poor", "bad". 
(The Norwegian terms for the five quality categories are *svært god*, *god*, *moderat*, *dårlig*, and *svært dårlig*. The verbatim translations of these terms would be "very good", "good", "moderate", "bad", and "very bad", respectively. Here, however, the categories are translated as "*high*", "good", "moderate", "*poor*", and "*bad*", respectively, because these are the established terms used in the [Water Framework Directive](#wfd).)

The stock quality score is obtained by combining the partial scores for the two criteria ("subnorms") of the quality norm:

(1) The (a) attainment of the conservation limit and (b) harvest potential are both expressed as *percentages*. The categorisation is accomplished with three different conversion tables, depending on the absolute spawning stock size (see [quality norm](#norm), App.&nbsp;II).

(2) Genetic integrity is expressed in terms of a categorical score with four levels: "high", "moderate", "poor", "bad". ("Good" is not used as a separate score by the relevant subcriterion. Although the highest score is referred to as "good/high", it coincides with the reference condition, i.e. the absence of any observable genetic impact from farmed salmon; it is therefore here treated as "high".)

The two scores obtained are combined using the one-out--all-out principle, i.e. the poorer of the two partial scores determines the overall score.

The simplified procedure reports stock quality as a categorical score with three levels: "good/high", "moderate" and "poor/bad".

<!--# What are the original units for the most relevant  variables in the data-->

### 2.4 Instructions for citing, using and accessing data

All data related to the quality norm and simplified procedure are publicly available but not machine-readable. 
They can be accessed by downloading the reports published by VRL (see [list of publications](https://www.vitenskapsradet.no/Rapporter), in Norwegian) and should be referred to by citing the specific report(s) used. 
Annual data on selected variables have been and can be obtained by contacting the leader or secretariat of the Committee (see [contact details](https://www.vitenskapsradet.no/Om-VRL/Kontakt)).

<!--# Is the data openly available? If not, how can one access it? What are the key references to the datasets?   -->


## 3. Indicator properties

Salmon has the ID **123** in the metadata table for ecological condition variables for use in Norway ([Czúcz et al. 2023](#czu23)).

### 3.1 Ecosystem Condition Typology Class (ECT)

The ECT of salmon is **B1** (compositional state) because the indicator is a measure of the abundance and population viability of a keystone species.

<!--# 
Describe the rationale for assigning the indicator to the ECT class. See https://oneecosystem.pensoft.net/article/58218/
This doesnt need to be very long. Maybe just a single sentence. 
-->

#### 3.1.1 Other condition typologies

In the Norwegian classification of ecological characteristics (*økologiske egenskaper*) according to Nybø & Evju ([2017](#nyb17), p. 35), the indicator represents **biodiversity** (*biologisk mangfold*).

In the distinction between *quality elements* according to the [Water Framework Directive](#wfd) (Annex&nbsp;V), the indicator represents the **fish fauna**.

<!--# Optional: Add text about other spesific standards, e.g. national standards, and how the indicator relates to these -->

### 3.2 Ecosystem condition characteristic

An intact river ecosystems can potentially support a large stock of wild salmon. 
Salmon thus acts as an indicator of different ecosystem condition characteristics, most importantly water quality, integrity of the biotic community, population abundance, and genetic integrity.

<!--# 
Describe the ecosystem condition characteristic represented in the indicator. See 10.3897/oneeco.6.e58218 for information on what these characteristics might be.
For example, and indicator called 'Trenching in mires' could be made to represent an ecosystem characteristic 'Intact hydrology'. The term 'characteristic' is used similar to the term 'criteria' in Multiple Criteria Decition Making.  
-->

### 3.3 Collinearities with other indicators

There are no known collinearities with other Ecosystem Condition indicators. 
Salmon stock quality will be correlated with an Ecosystem *Service* indicator "salmon harvest", however.

<!--# Describe known collinearities with other metrices (indicators or variables) that could become problematic if they were also included in the same Ecosystem Condition Assessment as the indicator described here. -->

### 3.4 Impact factors

Impact factors negatively affecting wild salmon are, in approximate decreasing order of importance (current impact and risk for future damage): 
salmon farming (via spread of salmon lice *Lepeophtheirus salmonis*, escape of farmed salmons, and infections), 
climate change, 
hydromorphological changes (regulation of rivers and lakes), 
other infections (not related to fish farming), 
alien species (mainly pink salmon *Oncorhynchus gorbuscha* and salmon fluke *Gyrodactylus salaris*), 
acid precipitation, 
contaminants, and 
overharvesting 
([VRL 2025](#vrl25), p. 115; cf. [Forseth et al. 2017](#for17)).

<!--# Describe the main natural and anthropogenic factors that affecst the metric -->

### 3.5 Spatial aggregation

The aggregation pathway used here has the following steps:

1. *Scaling.* The variable values are linearly scaled so that X~0~ becomes 0 and X~100~ becomes 1. Note that the resulting values may be larger than 1 (if X > X~100~).
2. *Temporal aggregration.* The scaled values are aggregated temporally by calculating an arithmetic average for the years in each three-year accounting period.
3. *Transformation.* The temporally aggregated values are transformed in a stepwise-linear manner in accordance with the [reference levels](#reference-levels).
4. *Thematic aggregration.* The transformed values of the attainment of the conservation limit and of the harvest potential are aggregated by combining them additively into an indicator of population status. Population status and genetic integrity are then aggregated by applying the one-out--all-out principle.
5. *Truncation.* If indicator values are larger than 1, they are truncated to&nbsp;1.
6. *Spatial aggregration.* Indicator values for the specific river systems are spatially aggregated using size-weighted arithmetic averages across all relevant water bodies (where "size" is the total *anadromous length* of the river system).

<!-- Describe in word the same aggregation pathway presented in the metadata.xlsx. If you have scaled against the reference value, it is especially important to know if you did any avergaing or summations etc. beforehand. An example text for a rather simple case could be: "The variable is scaled at the initial polygon level and the point estimate is a area-weighted arithmetic mean of all polygins. There is no transformation, and truncation is not needed as the indicator becomes naturally bound between 0 and 1". -->


## 4. Reference condition and levels

### 4.1 Reference condition

According to the [quality norm](#norm), a salmon stock is in the reference condition if it fulfils all of the following three conditions:

1. The *cumulative biomass of adult females* equals the conservation limit, which is "the amount of female salmons, measured in terms of weight, that has to spawn in order for the optimal number of smolt to be able to leave the river each year." The "optimal number of smolt" (which are young salmons that are ready to migrate towards the sea) means the number under undisturbed conditions.
2. The *harvest potential* equals the normal harvest level, which is "the level of harvest that the stock shall be able to sustain in a given year based on knowledge of natural survival at sea, and given that the stock at the same time reaches the conservation limit." Here, "natural survival at sea" means that the survival in the marine phase is unaffected by human activity.
3. The stock is not *genetically affected* by escaped farmed salmons (or other anthropogenic activity such as selective harvesting).

Note that the term "conservation limit" (Norw. *gytebestandsmål*, verbatim "target spawning stock"), contrary to a possible connotation of "conservation", is not a political target but is estimated based on available empirical evidence alone (see [Forseth et al. 2013](#for13)).

<!--# Define the reference condition (or refer to where it is defined). Note the distinction between reference condition and reference levels 10.3897/oneeco.5.e58216  -->

### 4.2 Reference levels

If one follows the procedure applied by the [Water Framework Directive](#wfd), the quality categories can be used to define reference levels for X~0~, X~20~, X~40~, X~60~, X~80~, and X~100~. 
The reference levels then follow from the [quality norm](#norm) (App.&nbsp;II and III) and need to be applied separately to its (sub)criteria: 

* For attainment of the conservation limit, there are three sets of reference levels, depending on the absolute size of the spawning population, delineating five categories ([quality norm](#norm), App. II-a): "bad" (X~0~ &le; X &le; X~20~), "poor" (X~20~ < X &le; X~40~), "moderate" (X~40~ < X &le; X~60~), "good" (X~60~ < X &le; X~80~), and "high" (X~80~ < X &le; X~100~).
* For harvest potential, the reference levels are X~40~&nbsp;=&nbsp;60%, X~60~&nbsp;=&nbsp;80%, X~80~&nbsp;=&nbsp;90%, and X~100~&nbsp;=&nbsp;100% ([quality norm](#norm), App. II-b).
* For genetic integrity, the categories can be represented as midpoints of the respective intervals, i.e. "bad" as 0.1, "poor" as 0.3, "moderate" as 0.5, and "high" as 0.9 (since "good" is not used).

The combination of these partial indicator values into the final indicator values follows Appendices I and II of the quality norm. 

The quality norm (Art.&nbsp;3) enforces the environmental *objective* that all stocks of salmon, with a few specified exceptions, shall have at least "good quality". 
According to the reference levels defined here, this amounts to the objective that X&nbsp;>&nbsp;X~60~).

<!--# 
If relevant (i.e. if you have normalised a variable), describe the reference levels used to normalise the variable. 

Use the terminology where X~0~ refers to the reference level (the variable value) denoting the worst possible condition; X~100~denotes the optimum or best possible condition; and X~*n*~, where in is between 0 and 100, denotes any other anchoring points linking the variable scale to the indicator scale (e.g. the threshold value between good and bad condition X~60^). 

Why was the current option chosen and how were the reference levels quantified? If the reference values are calculated as part of the analyses further down, please repeat the main information here.
-->

#### 4.2.1 Spatial resolution and validity

The spatial resolution of salmon reference levels is (the anadromous proportion of) the river system.

<!--# 
Describe the spatial resolution of the reference levels. E.g. is it defined as a fixed value for all areas, or does it vary. Also, at what spatial scale are the reference levels valid? For example, if the reference levels have a regional resolution (varies between regions), it might mean that it is only valid and correct to use for normalising local variable values that are first aggregated to regional scale. However, sometimes the reference levels are insensitive to this and can be used to scale variables at the local (e.g. plot) scale. 
-->


## 5. Uncertainties

### 5.1 General uncertainties

All empirical data utilised in the analyses are subject to *observation error*. 
Some underlying assumptions are also related to *sampling error*.

For example, harvest potential is estimated as actual harvest divided by the "normal harvest level". 
Whereas the actual harvest level is subject to noise (i.e. observation error), the normal harvest level is a function of at-sea survival, which is normally unknown, so that the median harvest potential of rivers thought to be fully recruited is used as a proxy.

No attempt is made to quantify these uncertainties, but they can be regarded as comparatively small for the salmon stocks that are assessed using the quality norm. 
However, salmon stocks that are assessed using the simplified procedure are more uncertain. 
This is visible from the fact that the simplified procedure does not distinguish between "good" and "high" status or between "poor" and "bad" status. 
In addition, data on genetic integrity are unavailable for most of the latter stocks.

A further uncertainty is related to the most appropriate weighting of river systems. 
The relevant magnitude for weighting is the size of the anadromous part of each river system. 
Estimates of both anadromous area and anadromous length are available. 
However, whereas area should in principle be preferred, other river indicators are weighted by the lengths of the ecosystem assets (areas being currently unavailable). 
Therefore, to ensure compatibility with other river indicators, the current indicator is weighted by length, too.
Anadromous lengths may be biased (i.e. overestimated) by long and narrow tributaries, however. 
These questions are as yet unexplored.

<!--# Describe the main reasons why you might not trust 100% the final value to represent the given ecosystem characteristic for the give ecosystem type. What aspects of this condition metric are most sensitive to subjective decitions? Is the spatial sampling sufficient? Does the choice of modeling framework affect the values? Is the metric relevant do describe ecosystem condition for the give ecosystem type?  -->

### 5.2 Reported uncertainties

The uncertainties related to missing data and to the simplified procedure are estimated using a re-sampling procedure. 
The uncertainties reported are thus inferential, i.e. they refer to the uncertainty around the point estimates. 
Details on the re-sampling procedure are provided [below](#randomisation).

<!-- Describe the nature of the errors you (hopefully) provide alongside the point estimate for the condition metric. It is especially important to clarify if the errors are inferential (referring to the uncertainty of the point estimate) or descriptive (referreing to the data itself). Here' an example text: "What we report as uncertainties in @tbl-finalTable are inferential and refer to the uncertainty around the point estimates. It does not directly describe variation in the data itself. 
However, the variation in the mean is defined by the spatial variation only, and quartiles are obtained by bootstrapping the set of localities within a region, and calculating the indicator for each of 9999 such samples".   -->


## 6. References

<span id="czu23">Czúcz B, Sandvik H, Framstad E & Schartau AK.</span> 2023. Metadata for ecological condition variables for use in Norway, version 1.0. [[doi:10.5281/zenodo.10187828](https://doi.org/10.5281/zenodo.10187828)]

<span id="dis23">Diserud OH, Hindar K, Karlsson S, Glover KA & Skaala Ø.</span> 2023. Genetisk påvirkning av rømt oppdrettslaks på ville laksebestander -- oppdatert status 2023. *NINA Rapp* **2393**: 1--98. [[hdl:11250/3108558](https://hdl.handle.net/11250/3108558)]

<span id="for13">Forseth T, Fiske P, Barlaup B, Gjøsæter H, Hindar K & Diserud OH.</span> 2013. Reference point based management of Norwegian Atlantic salmon populations. *Environ Conserv* **40**: 356--366. [[doi:10.1017/S0376892913000416](https://doi.org/10.1017/S0376892913000416)]

<span id="for17">Forseth T, Barlaup BT, Finstad B, Fiske P, Gjøsæter H, Falkegård M, Hindar A, Mo TA, Rikardsen AH, Thorstad EA, Vøllestad LA & Wennevik V.</span> 2017. The major threats to Atlantic salmon in Norway. *ICES J Mar Sci* **74**: 1496--1513. [[doi:10.1093/icesjms/fsx020](https://doi.org/10.1093/icesjms/fsx020)]

<span id="norm">**Kvalitetsnorm** for ville bestander av atlantisk laks.</span> 2013. Kvalitetsnorm for ville bestander av atlantisk laks (*Salmo salar*). *Nor Lovtid I* **2013**: 2226&ndash;2230. [[FOR-2013-09-20-1109](https://lovdata.no/forskrift/2013-09-20-1109)]

<span id="nyb17">Nybø S & Evju M (eds).</span> 2017. *Fagsystem for fastsetting av god økologisk tilstand. Forslag fra et ekspertråd.* Klima- og miljødepartementet, Oslo. <https://www.regjeringen.no/id2558481/>

<span id="san25">Sandvik H.</span> 2025. WFD2ECA: Dataflyt fra vannforskriften til økologisk tilstandsregnskap og naturindeks, version 2.0. <https://github.com/NINAnor/WFD2ECA> [[doi:10.5281/zenodo.10278000](https://doi.org/10.5281/zenodo.10278000)]

<span id="seeaea">**SEEA EA**:</span> United Nations et al. 2024. *System of Environmental-Economic Accounting -- Ecosystem Accounting.* UN, New York. <https://seea.un.org/ecosystem-accounting>

<span id="vrl11">VRL.</span> 2011. Kvalitetsnormer for laks -- anbefalinger til system for klassifisering av villaksbestander. *Temarapp Vitensk Råd Lakseforvalt* **1**: 1--105. [[hdl:11250/2392373](https://hdl.handle.net/11250/2392373)]

<span id="vrl17">VRL.</span> 2017. Forslag til forenklet tilstandsvurderingssystem for laksebestander. *Rapp Vitensk Råd Lakseforvalt* **10**: 117--134. [[hdl:11250/2446896](https://hdl.handle.net/11250/2446896)]

<span id="vrl18">VRL.</span> 2018. Klassifisering av tilstand i norske laksebestander 2010--2014. *Temarapp Vitensk Råd Lakseforvalt* **6**: 1--75. [[hdl:11250/2488936](https://hdl.handle.net/11250/2488936)]

<span id="vrl21">VRL.</span> 2021. Status for norske laksebestander i 2021. *Rapp Vitensk Råd Lakseforvalt* **16**: 1--227. [[hdl:11250/2830680](https://hdl.handle.net/11250/2830680)]

<span id="vrl25">VRL.</span> 2025. Status for norske laksebestander i 2025. *Rapp Vitensk Råd Lakseforvalt* **21**: 1--140. [[hdl:11250/3197886](https://hdl.handle.net/11250/3197886)]

<span id="wfd">**Water Framework Directive**:</span> EU. 2000. Directive 2000/60/EC of the European Parliament and of the Council of 23 October 2000 establishing a framework for Community action in the field of water policy. *Off J EU L* **43** (327): 1&ndash;72. [[CELEX:32000L0060](http://eur-lex.europa.eu/LexUriServ/LexUriServ.do?uri=CELEX:32000L0060:en:NOT)]
  
<!--# You can add references manually or use a citation manager and add intext citations as with crossreferencing and hyperlinks. See https://quarto.org/docs/authoring/footnotes-and-citations.html -->


## 7. Import and prepare datasets

<!--# Describe the unique datasets seperately under seperate headers (Dataset A, Dataset B, etc.-->

### 7.1 Quality norm

Upon solicitation from the [Norwegian Environment Agency](http://www.miljodirektoratet.no), VRL classifies the most important salmon rivers according to the quality norm. 
The last such comprehensive classification, for the years 2015--2019, was published in 2021 ([VRL 2021](#vrl21)). 
The classification for the years 2020--2024 is not yet published, because the Norwegian Environment Agency has still not solicited it. 
This means that, for the time being, the 2019 assessment has to be used.

The data are taken directly from table 11.5 in VRL ([2021](#vrl21)) by exporting the pdf of the report to excel. 
The only change made is that short column titles have been added to row&nbsp;4.
We start by reading the spreadsheet and displaying the structure of the dataset.

```{r}
salmon <- as.data.frame(read_xlsx("../data/VRL2021.xlsx", col_types = "text", skip = 3))
print(head(salmon))
```

### 7.2 Conservation limit and harvest potential

Some variables contributing to the comprehensive classification are assessed on an annual basis by the VRL. 
This includes the attainment of the conservation limit (*Måloppn[åelse]*) and the harvest potential (*Høstingspot[ensial]*) for the most important salmon rivers. 
Although these assessment are the basis of the comprehensive classifications, VRL uses to publish five-year averages of these variables rather than the annual values. 
The annual values were therefore obtained from the VRL (Peder Fiske, pers. comm.). 
The dataset (excel sheet) also contains some other relevant variables, such as the size of the breeding stock (*Bestandsstørrels[e]*).

```{r}
laks <- as.data.frame(read_xlsx("../data/Laks1624.xlsx", col_types = "text"))
laks$GBM         <- as.numeric(laks$GBM)
laks$Måloppn     <- as.numeric(laks$Måloppn)
laks$Høstingspot <- as.numeric(laks$Høstingspot)
laks$Måloppn[      which(is.na(laks$Kvalitetsnorm))] <- NA
laks$Høstingspot[  which(is.na(laks$Kvalitetsnorm))] <- NA
laks <- laks[order(laks$Aar), ]
laks <- laks[order(laks$VdrNr), ]
print(head(laks))
```

### 7.3 Genetic integrity

The genetic integrity of salmon stocks is assessed every fifth year according to the quality norm. 
As mentioned above, the assessment for 2024 has not yet been caried out. 
However, the data that the VRL will use when classifying the genetic integrity in 2024, have already been published ([Diserud et al. 2023](#dis23)).
They are read here from an excel sheet that contains the relevant information from table 1 in Diserud et al. ([2023](#dis23); obtained from Ola Diserud, pers. comm.).

```{r}
gen23 <- as.data.frame(read_xlsx("../data/GenInt23.xlsx", col_types = "text"))
print(head(gen23))
```

### 7.4 Anadromous river lengths

Information on the anadromous parts of Norwegian river systems are read from a separate file. 
This information has been used to estimate conservation limits ([Forseth et al. 2013](#for13)). 
The file has been supplied by VKL (Torbjørn Forseth, pers. comm.).
Lengths are provided in metres and areas in square metres.

```{r}
vassdrag <- as.data.frame(read_xlsx("../data/Anadromi.xlsx", 
  col_types = c("numeric", "text", "text", rep("numeric", 5))))
print(head(vassdrag))
```

### 7.5 River coordinates

River coordinates are only needed for the visualisation of the results; they are not needed for the analyses. 
The data used are from the *Hovedfelt* dataset maintained by the Norwegian Water Resources and Energy Directorate ([NVE](https://www.nve.no/)). 
This dataset is publicly available, but it needs to be downloaded manually:

* Navigate to [https://nedlasting.nve.no/gis/](https://nedlasting.nve.no/gis/).
* Choose (or retain) "Vektordata" in the "Velg datatype" dropdown menu.
* Expand the "Elv" heading.
* Tick the "Hovedelv" box.
* Click "Neste".
* Choose "ESRI shapefil (.shp)" in the "Velg kartformat" dropdown menu.
* Choose "Geografiske koordinater ETRS89" in the "Velg koordinatsystem" dropdown menu.
* Choose "Overlapper" in the "Velg utvalgsmetode" dropdown menu.
* Choose "Landsdekkende" in the "Velg dekningsområde" dropdown menu.
* Click "Neste".
* Provide your e-mail address in the "E-post" boxes.
* Tick the "Jeg har lest og forstått betingelser..." box to accept the terms of use.
* Upon pressing "Send", a link to a compressed archive (zip) will be sent to your e-mail.
* Click that link to download the data.
* Uncompress the zip archive. (Upon uncompression, the relevant files are located in the folder `NVEKartdata\NVEData\Elv`.)
* Place the shapefiles (called `Elv_Hovedelv.*`) in the "data" folder.

(The [analyses](#analyses) use a cached version called "elver.RData".)

```{r}
# To read the NVE export, unzip the shapefiles and place them in the "data" folder.
# Then load them using the read_sf function:
# elv <- read_sf("../data/Elv_Hovedelv.shp")
# elv <- elv[which(elv$nbfVassNr %in% salmon$Vnr), ]

# The shapefile is rather huge (131 MB), so a cached version is loaded instead:

load("../data/elver.RData")
print(head(elv))
```

<!--# Describe the main dataset, typicaly the one containing the variable of (most) interest. Change the header from Dataset A to the name of the actual dataset. -->

<!--# Describe additional datasets in a similar was as above. Delete or add ned subheaders as needed. -->


## 8. Spatial units

The spatial units of quality assessment of salmon stocks are *river systems* (Norw. *vassdrag*), specifically their anadromous proportion (i.e., the part of a river system which is accessible to salmons). 
The Ecosystem Accounting Area covered by the data is mainland Norway. 

<!--# 
Describe the spatial units that you rely on in your analyses. Highlight the spatial units (the resolution) that the indicator values should be interpretted at. Potential spatial delineation data should eb introduced under 7.1. Datasets. We recomend using the SEEA EA terminology opf Basic Spatial Units (BSU), Ecosystem Asses (EA) and Ecosystem Accounting Area (EAA). 
-->


## 9. Analyses

### 9.1 Preliminaries

We start by loading some functions from the [WFD2ECA](https://github.com/NINAnor/WFD2ECA/) repository ([Sandvik 2025](#san25)), which will be used in the following analyses.

```{r}
source(url("https://github.com/NINAnor/WFD2ECA/raw/refs/heads/main/R/Funksjon.R"))
load(  url("https://github.com/NINAnor/WFD2ECA/raw/refs/heads/main/data/Norge.map"))
```

In addition, some specialised functions need to be defined, e.g. for translating status categories into continuous scores, and for randomising uncertain values.

```{r}
# Function returning a numerical indicator value for each stock status category
status2indicator <- function(status) return(
  ifelse(status == "H",   0.9,
  ifelse(status == "G-H", 0.8,
  ifelse(status == "G",   0.7,
  ifelse(status == "M",   0.5,
  ifelse(status == "P",   0.3,
  ifelse(status == "P-B", 0.2,
  ifelse(status == "B",   0.1,
  NA)))))))
)



# Function returning stock status category for a numerical indicator value 
indicator2status <- function(indicator) return(
  ifelse(abs(indicator - 0.9) < 1e-4, "H",
  ifelse(abs(indicator - 0.8) < 1e-4, "G-H",
  ifelse(abs(indicator - 0.7) < 1e-4, "G",
  ifelse(abs(indicator - 0.5) < 1e-4, "M",
  ifelse(abs(indicator - 0.3) < 1e-4, "P",
  ifelse(abs(indicator - 0.2) < 1e-4, "P-B",
  ifelse(abs(indicator - 0.1) < 1e-4, "B",
  NA)))))))
)



# Function returning the name of a stock status category for its abbreviation 
status2name <- function(status) return(
  ifelse(status == "H",   "High",
  ifelse(status == "G-H", "High-Good",
  ifelse(status == "G",   "Good",
  ifelse(status == "M",   "Moderate",
  ifelse(status == "P",   "Poor",
  ifelse(status == "P-B", "Poor-Bad",
  ifelse(status == "B",   "Bad",
         status)))))))
)



# Function creating random nEQR values for moderate status
rEQR.M <- function(n) {
  R <- runif(n)
  return(ifelse(R < 0.25, 0.4 - rbeta(n, 1, 2) * 0.2,
         ifelse(R > 0.75, 0.6 + rbeta(n, 1, 2) * 0.2,
                          0.4 + runif(n)       * 0.2)))
}



# Function creating random nEQR values for poor/bad status
rEQR.PB <- function(n) {
  R <- runif(n)
  return(ifelse(R > 0.8, 0.4 + rbeta(n, 1, 2) * 0.2, runif(n, 0.0, 0.4)))
}



# Function creating random nEQR values for good/high status
rEQR.GH <- function(n) {
  R <- runif(n)
  return(ifelse(R < 0.2, 0.6 - rbeta(n, 1, 2) * 0.2, runif(n, 0.6, 1.0)))
}



# Function returning the lowest value of the mean and the median of a vector
mid <- function(x) min(mean(x, na.rm = TRUE), median(x, na.rm = TRUE))



# Function returning the statistical mode of a vector
mode <- function(x) names(sort(-table(x)))[1]



# Function reversing a matrix with river coordinates
snu <- function(x) {
  x[, 4] <- max(x[, 4]) - x[, 4]
  x <- x[nrow(x):1, ]
}
```

We define 2018, 2021 and 2024 as accounting years, each of which utilises data from three years.

```{r}
accYears <- c(2018, 2021, 2024)
allYears <- sort(rep(accYears, each = 3) - 2:0) # years to be included in accounts
accYears <- as.character(accYears)
allYears <- as.character(allYears)
```

We define the quantiles we want to estimate for the indicator as the median, the quartiles and the lower/upper 95% confidence levels.

```{r}
Qnt <- c(0.025, 0.25, 0.5, 0.75, 0.975)
```

Simulations/randomisation is done by drawing 10,000 random numbers for each river system with uncertain variable values.

```{r}
nsim <- 10000
set.seed(prod(1:12))
```

### 9.2 Prepare the salmon data

We start by tidying up the salmon data file.

```{r}
for (i in 1:ncol(salmon)) {
  salmon[, i] <- erstatt(salmon[, i], "\r\n", " ")
}
salmon$Vnr <- erstatt(salmon$Vnr, " ", "")
salmon$Gytekg[which(salmon$Gytekg == "Mangler")] <- NA
salmon$Kval   <- salmon$Kval == "1"
salmon$Gytekg <- as.numeric(salmon$Gytekg)
salmon$GBM    <- as.numeric(salmon$GBM)
salmon$HP     <- as.numeric(salmon$HP)
Status        <- salmon$Tilstand
salmon$Gyro   <- salmon$Bestand == "G. salaris"
salmon$Nedskr <- tolower(salmon$Merk) %inneholder% "nedskrev"
for (w in c("Bestand", "Genetikk", "Tilstand")) {
  salmon[, w] <- tolower(salmon[, w])
  salmon[, w] <- erstatt(salmon[, w], " ", "")
  salmon[, w] <- erstatt(salmon[, w], "sværtdårlig", "B")
  salmon[, w] <- erstatt(salmon[, w],   "g.salaris", "B")
  salmon[, w] <- erstatt(salmon[, w],    "sværtgod", "H")
  salmon[, w] <- erstatt(salmon[, w],     "moderat", "M")
  salmon[, w] <- erstatt(salmon[, w],      "dårlig", "P")
  salmon[, w] <- erstatt(salmon[, w],         "god", "G")
  salmon[, w] <- erstatt(salmon[, w],           "/", "-")
  salmon[, w] <- erstatt(salmon[, w],       "H-G", "G-H")
  salmon[, w] <- erstatt(salmon[, w],       "B-P", "P-B")
  salmon[, w] <- ifelse( salmon[, w] %in% c("B", "P-B", "P", "M", "G", "G-H", "H"),
                         salmon[, w], NA)
}
salmon$Genetikk[salmon$Genetikk == "G-H"] <- "H"
{
  tab <- salmon[, c(1:11, ncol(salmon) - 1:0)]
  tab$Vnavn <- substr(tab$Vnavn, 1, 20)
  print(head(tab))
  rm(tab)
}
```

For different reasons, a few river systems have not been classified.

```{r}
w <- which(!(salmon$Tilstand %in% c("B", "P-B", "P", "M", "G", "G-H", "H")))
if (length(w)) print(table(Status[w]))
```

These missing values are treated as follows:

* Rivers with "no stock" (*ikke bestand*) are removed, as the number of spawning females is so low that the river system should not have been included in the dataset in the first place (Torbjørn Forseth, pers. comm.). 
* Rivers that are "not classified" (*ikke klassifisert*) or where stocks are "under reestablishment" (*under reetablering*) will be randomised based on the nearest ten river systems on either side.

```{r}
salmon$Bestand[   which(Status == "Ikke klassifisert") ] <- NA
salmon$Bestand[   which(Status == "Under reetablering")] <- NA
salmon <- salmon[-which(Status == "Ikke bestand"), ]
```

### 9.3 Description of the workflow

The indicator values will be estimated following the same procedure that is used in the quality norm. 
Status categories are translated into numerical values between 0 and 1 in the same way as in the [Water Framework Directive](#wfd), i.e. by calculating "normalised Ecological Quality Ratios" (*nEQR*). 
There are basically two ways of achieving this, and we recommend the first one but will illustrate the use of both of them:

* Estimating continuous nEQRs for all salmon rivers, and then calculating a national indicator value as the weighted mean of the nEQRs. This alternative is preferred because it does not discard any information, and the resulting value is directly interpretable as an nEQR value. On the other hand, values estimated in this way can be expected to deviate somewhat from ones estimated from the categorical salmon stock statuses that are reported in the [*Vann-nett*](https://vann-nett.no/) database.
* Turning the status categories into discrete numerical values on nEQR scale, and then calculating a national indicator value as the weighted mean of the latter. "Discrete numerical values on nEQR scale" means that the status categories ("bad", "poor", "moderate", "good", "high") are replaced by the midpoint of the respective nEQR intervals (0.1, 0.3, 0.5, 0.7, 0.9, respectively). This alternative entails the loss of information (by introducing an additional and unnecessary rounding error) and is therefore not recommended, although its results will have a rather close resemblance to the ones estimated from the categorical salmon stock statuses that are reported in the *Vann-nett* database.

The workflow is as follows:

1. Variables that are available on an annual basis (attainment of the conservation limit, harvest potential), are averaged for each three-year accounting period. For example, the value for 2024 is based on the average of these variables for the period 2022--2024.
2. Variables that are *not* available on an annual basis (genetic integrity, population status scores based on the simplified procedure), are taken from the most recently published account and used for all accounting periods after the previously published account. For example, genetic integrity is available for 2019 ([VRL 2021](#vrl)) and 2023 ([Diserud et al. 2023](#dis23)), so that the former estimates are used for the years 2016--2018, and the latter ones for 2019--2021 and 2022--2024.
3. Uncertain or missing values are filled in using a re-sampling procedure, i.e randomisation.
4. Variable values are transformed into nEQR values (continuous or discrete ones) using the reference levels defined in the quality norm.
5. The rules in the quality norm are used to calculate the population status *P* for each accounting period. For the categorical version of the indicator, this entails that the attainment of the conservation limit *C* and the harvest potential *H* are combined according to Appendix&nbsp;II of the quality norm (additively). For the continuous version, the nEQR values are combined using the equation *P* = *C* + *H* &minus; 0.9, thereafter truncating values >&nbsp;1 to&nbsp;1 and values <&nbsp;0 to&nbsp;0.
6. Adjustments are made for salmon stocks that are infested with *G. salaris* (bad status) or where the release of cultivated fish implies a reduction in effective stock size (nEQR reduced by 0.2 units; cf. quality norm, App. II-a).
7. The rules in the quality norm are used to calculate the overall stock quality *Q* for each accounting period. For the categorical version of the indicator, this entails that the population status *P* and the genetic integrity *G* are combined according to Appendix&nbsp;I of the quality norm (one-out--all-out principle). For the continuous version, *Q* is obtained as *Q*&nbsp;= *P*&nbsp;&minus; *n*&nbsp;&middot;&nbsp;0.2, where *n*&nbsp;= trunc(*P*&nbsp;&middot;&nbsp;5)&nbsp;&minus; trunc(*G*&nbsp;&middot;&nbsp;5) iff trunc(*P*&nbsp;&middot;&nbsp;5)&nbsp;>&nbsp;trunc(*G*&nbsp;&middot;&nbsp;5), and *n*&nbsp;=&nbsp;0 otherwise.
8. Finally, the indicator values are aggregated spatially to obtain national or regional averages. Averages are weighted by the anadromous length of each river system.

### 9.4 Estimation of variable values

We define matrices for the variables that are available on an annual basis.

```{r}
ConsLim  <- # attainment of the conservation limit
HarvPot <-  # harvest potential
  matrix(NA, nrow(salmon), length(allYears), dimnames = list(salmon$Vnr, allYears))
for (i in 1:nrow(ConsLim)) {
  w <- sort(which(laks$VdrNr == rownames(ConsLim)[i] & laks$Aar %in% allYears))
  if (laks$Aar[w] %=% allYears) {
    ConsLim[i, allYears] <- laks$Måloppn[w]
    HarvPot[i, allYears] <- laks$Høstingspot[w]
  }
}
{ # Output:
  cat("Attainment of conservation limit:\n")
  print(head(round(ConsLim, 2)))
  cat("\nHarvest potential:\n")
  print(head(round(HarvPot, 2)))
}
```

There is one row per river system. 
So far, values are missing for river systems that are assessed using the simplified procedure. 
They will be filled in later.

We then do the same for the variables that are needed once per accounting year. 
Where relevant, we fill in information available from the 2019 and 2023 assessments.

```{r}
meanConsLim <- # three-year average of the attainment of the cosnervation limit
meanHarvPot <- # three-year average of the harvest potential
PopCat <-      # categorical population status
PopCont <-     # continuous population status
SimplProc <-   # river system assessed using the simplified procedure (logical)
PopSimpl <-    # population status according to the simplified procedure
Gyro <-        # occurrence of Gyrodacylus salaris (logical)
SpawnPop <-    # size class of the spawning stock
DownScale <-   # downscaling of the attainment of the conservation limit (logical)
GenInt <-      # genetic integrity
QualCat <-     # categorical stock quality
QualCont  <-   # continuous stock quality
  matrix(NA, nrow(salmon), length(accYears), dimnames = list(salmon$Vnr, accYears))

SimplProc[] <- !salmon$Kval
for (y in accYears) PopSimpl[SimplProc[, y], y] <- salmon$Bestand[SimplProc[, y]]
DownScale[] <- salmon$Nedskr
Gyro[]      <- salmon$Gyro

for (i in 1:nrow(ConsLim)) {
  for (y in accYears) {
    w <- which(laks$VdrNr == rownames(ConsLim)[i] & laks$Aar == y)
    if (length(w) %=% 1) {
      SpawnPop[i, y] <- laks$Bestandsstørrels[w]
    }
    if (is.na(SpawnPop[i, y]) & !SimplProc[i, y]) {
      SpawnPop[i, y] <- "Middels"
      if (salmon$Gytekg[i] < 124) SpawnPop[i, y] <- "Liten"
      if (salmon$Gytekg[i] > 630) SpawnPop[i, y] <- "Stor"
    }
  }
}

gen23$Kategori <- c(SG = "H", G = "G", M = "M", D = "P", SD = "B")[gen23$Kategori]
GenInt[, "2018"] <- status2indicator(salmon$Genetikk)
GenInt[, "2021"] <- status2indicator(salmon$Genetikk)
for (i in 1:nrow(gen23)) {
  w <- which(salmon$Vnr == gen23$Vdr.no[i])
  if (length(w)) {
    GenInt[w, "2024"] <- status2indicator(gen23$Kategori[i])
  }
}
```

Salmon stock quality is then estimated for each accounting period, following the procedure of the quality norm, based on the 
(i)&nbsp;mean attainment of the conservation limit, 
(ii)&nbsp;mean harvest potential, 
(iii)&nbsp;spawning population size, 
(iv)&nbsp;reasons for downscaling (release of cultivated fish), and
(v)&nbsp;presence of *G.&nbsp;salaris*.

```{r}
for (y in accYears) {
  years <- which(colnames(ConsLim) %in% (as.character(as.numeric(y) - 2:0)))
  
  # averaging values for each accounting period:
  w <- which(SpawnPop[, y] == "Middels")
  meanHarvPot[, y] <- apply(HarvPot[, years], 1, mean, na.rm = TRUE)
  meanConsLim[, y] <- apply(ConsLim[, years], 1, mean, na.rm = TRUE)
  meanConsLim[w,y] <- apply(ConsLim[w,years], 1, mid)
  # the latter exception accounts for the footnote of the norm, App II-a
  
  # defining temporary variables:
  CL <- CL. <- meanConsLim[, y]
  HP <- HP. <- meanHarvPot[, y]
  
  # table 1 of quality norm, App. II-a:
  w <- which(SpawnPop[, y] == "Stor")
  CL[w] <- (CL.[w] - 90) /  50 + 0.8
  w <- which(SpawnPop[, y] == "Stor" & CL. < 90)
  CL[w] <- (CL.[w] - 80) /  50 + 0.6
  w <- which(SpawnPop[, y] == "Stor" & CL. < 80)
  CL[w] <- (CL.[w] - 70) /  50 + 0.4
  w <- which(SpawnPop[, y] == "Stor" & CL. < 70)
  CL[w] <- (CL.[w] - 50) / 100 + 0.2
  w <- which(SpawnPop[, y] == "Stor" & CL. < 50)
  CL[w] <- (CL.[w] -  0) / 250 + 0.0
  
  # table 2 of quality norm, App. II-a:
  w <- which(SpawnPop[, y] == "Middels")
  CL[w] <- (CL.[w] - 95) /  25 + 0.8
  w <- which(SpawnPop[, y] == "Middels" & CL. < 95)
  CL[w] <- (CL.[w] - 90) /  25 + 0.6
  w <- which(SpawnPop[, y] == "Middels" & CL. < 90)
  CL[w] <- (CL.[w] - 70) / 100 + 0.4
  w <- which(SpawnPop[, y] == "Middels" & CL. < 70)
  CL[w] <- (CL.[w] - 60) /  50 + 0.2
  w <- which(SpawnPop[, y] == "Middels" & CL. < 60)
  CL[w] <- (CL.[w] -  0) / 300 + 0.0
  
  # table 3 of quality norm, App. II-a:
  w <- which(SpawnPop[, y] == "Liten")
  CL[w] <- (CL.[w] - 99) * 0.4 + 0.6
  w <- which(SpawnPop[, y] == "Liten" & CL. < 99)
  CL[w] <- (CL.[w] -  0) / 500 + 0.4
  
  # downscaling, cf. 2nd section of quality norm, App. II-a
  CL <- CL - 0.2 * DownScale[, y]
  meanConsLim[, y] <- sapply(CL, max, 0)
  
  # table 1 of quality norm, App. II-b:
  HP    <- (HP.    - 90) /  50 + 0.8
  w <- which(HP. < 90) 
  HP[w] <- (HP.[w] - 80) /  50 + 0.6
  w <- which(HP. < 80)
  HP[w] <- (HP.[w] - 60) / 100 + 0.4
  w <- which(HP. < 60)
  HP[w] <- (HP.[w] -  0) / 300 + 0.2
  meanHarvPot[, y] <- sapply(HP, min, 1.2)
  
  # tables 2-4 of quality norm, App. II-b:
  PopCont[, y] <- meanConsLim[, y] + meanHarvPot[, y] - 0.9
  PopCont[, y] <- ifelse(   Gyro[, y], 0, 
                  ifelse(PopCont[, y] < 0.1, (PopCont[, y] + 0.7) / 8,
                  ifelse(PopCont[, y] > 1, 1, PopCont[, y])))
  PopCat[, y] <- 0.9
  PopCat[, y] <- PopCat[, y] - 0.2 * (meanConsLim[, y] < 0.8)
  PopCat[, y] <- PopCat[, y] - 0.2 * (meanConsLim[, y] < 0.6)
  PopCat[, y] <- PopCat[, y] - 0.2 * (meanConsLim[, y] < 0.4)
  PopCat[, y] <- PopCat[, y] - 0.2 * (meanConsLim[, y] < 0.2)
  PopCat[, y] <- PopCat[, y] - 0.2 * (meanHarvPot[, y] < 0.8)
  PopCat[, y] <- PopCat[, y] - 0.2 * (meanHarvPot[, y] < 0.6)
  PopCat[, y] <- PopCat[, y] - 0.2 * (meanHarvPot[, y] < 0.4)
  PopCat[, y] <- sapply(PopCat[, y], max, 0.1)
  
  # rivers with Gyrodactylus salaris have bad status:
  PopCat[, y] <- ifelse(Gyro[, y], 0.1, PopCat[, y])
  
  # applying quality norm, App. I
  rest <- round(PopCont[, y], 4) %% 0.2
  QualCont[,y] <- apply(cbind(PopCont[,y] - rest, GenInt[, y] - 0.1), 1, min) + rest
  QualCat[, y] <- apply(cbind(PopCat[, y],        GenInt[, y]),       1, min)
  
  # fill in quality where one partial norm is in "bad status"
  w <- which(is.na(  GenInt[ , y]) & PopCont[, y] < 0.2)
  QualCont[w, y] <- PopCont[w, y]
  QualCat [w, y] <- PopCat [w, y]
  w <- which(is.na (PopCont[ , y]) & GenInt [, y] < 0.2)
  QualCont[w, y] <-  GenInt[w, y]
  QualCat [w, y] <-  GenInt[w, y]
}

{ # Output:
  cat("Continuous stock qualities:\n")
  print(head(round(QualCont, 3)))
  cat("\nCategorical stock qualities:\n")
  print(head(QualCat))
}
```

There are still quite many missing values. These fall into two categories:

* A few missing data for stocks that should have been assessed according to the quality norm.
* Uncertainty attached to stocks that have been assessed according to the simplified procedure.

```{r}
y <- accYears[length(accYears)]
tab <- table(SimplProc[, y], QualCat[, y], useNA = "i")
rownames(tab) <- c("Quality norm", "Simpl. proc.")
print(tab)
```

### 9.5 Randomisation

The missing values are filled in using a randomisation procedure. 
This entails the following steps:

* Population statuses obtained by the simplified procedure are replaced by random numbers that are drawn from a uniform distribution covering the relevant interval (i.e. 0.0--0.4 for "poor/bad", 0.4--0.6 for "moderate", and 0.6--1.0 for "good/high"). To take into account that the simplified procedure may have misassigned a status category, some random numbers are also drawn from a beta(1,2) distribution (i.e. triangular), assuming decreasing probability with increasing distance from the boundary, reaching 0 at 0.2 units from the relevant reference level. There is thus a 20% probability that rivers classified as "poor/bad" or "good/high" get a value corresponding to "moderate" status; and a 25% probability each way that rivers classified as "moderate" status get a value corresponding to "poor" or "good" status (but not "bad" or "high" status).
* Missing values for genetic integrity are replaced by values that are drawn at random from the ten neighbouring river systems at either side, only considering values from the same reporting period.
* The same is done with the (very few) missing values for population status.

For each simulated set of variables, the categorical and continuous stock qualities are estimated, using the same workflow as for known variables. 
The number of simulations (`nsim`) has been defined [above](#preliminaries).

```{r}
IndCont <- array(QualCont, c(nrow(salmon), length(accYears), nsim),
                 list(rownames(QualCont), accYears, "sim" %+% 1:nsim))
IndCat  <- array(QualCat,  c(nrow(salmon), length(accYears), nsim),
                 list(rownames(QualCont), accYears, "sim" %+% 1:nsim))
missing <- is.na(IndCont[, , 1])

for (y in accYears) {
  for (i in which(missing[, y])) {
    if (is.na(PopCont[i, y])) {
      if (is.na(PopSimpl[i, y])) {
        # will be handled in the next loop
      } else {
        W <- rep(0, 5)
        if (PopSimpl[i, y] %=% "G-H") {
          IndCont[i, y, ] <- rEQR.GH(nsim)
          IndCat[ i, y, ] <- sample(c(0.7, 0.9), nsim, TRUE)
        }
        if (PopSimpl[i, y] %=% "P-B") {
          IndCont[i, y, ] <- rEQR.PB(nsim)
          IndCat[ i, y, ] <- sample(c(0.1, 0.3), nsim, TRUE)
        }
        if (PopSimpl[i, y] %=% "M") {
          k <- status2indicator(PopSimpl[i, y])
          IndCont[i, y, ] <- rEQR.M(nsim)
          IndCat[ i, y, ] <- rep(k, nsim)
        }
        if (PopSimpl[i, y] %in% c("B", "P", "G", "H")) {
          skriv("River system ", rownames(IndCont)[i], " has status \"", 
                PopSimpl[i, y], "\" in ", y, ", which shouldn't be possible!")
        }
      }
    } else {
      IndCont[i, y, ] <- rep(PopCont[i, y], nsim)
      IndCat[ i, y, ] <- rep(PopCat[ i, y], nsim)
    }
  }
  for (i in which(missing[, y])) {
    if (is.na(PopCont[i, y])) {
      if (is.na(PopSimpl[i, y])) {
        k <- na.omit(as.vector(IndCont[c(i-10:1, i+1:10) %A% 1:nrow(salmon), y, ]))
        IndCont[i, y, ] <- sample(k, nsim, TRUE)
        k <- na.omit(as.vector(IndCat[ c(i-10:1, i+1:10) %A% 1:nrow(salmon), y, ]))
        IndCat[ i, y, ] <- sample(k, nsim, TRUE)
      } else {
        # was handled in the previous loop
      }
    } else {
      # was handled in the previous loop
    }
    if (is.na(GenInt[i, y])) {
      k <- as.vector(na.omit(GenInt[c(i - 10:1, i + 1:10) %A% 1:nrow(salmon), y]))
      G <- sample(k, nsim, TRUE)
    } else {
      G <- rep(GenInt[i, y], nsim)
    }
    rest <- round(IndCont[i, y, ], 4) %% 0.2
    IndCont[i, y, ] <- apply(cbind(IndCont[i, y, ] - rest, G - 0.1), 1, min) + rest
    IndCat[ i, y, ] <- apply(cbind(IndCat[ i, y, ],        G),       1, min)
  }
}
if (any(is.na(IndCat)) | any(is.na(IndCont))) {
  skriv("For some reason, there are still some <NA> values in the quality scores.",
        " This needs to be looked into!", pre = "NB: ")
} else {
  skriv("Everything worked out: estimated or randomised values are available ",
        "for each river system.")
}
```

### 9.6 Spatial aggregation of indicator values

Indicator values need to be weighted by the size of the ecosystem assets when calculating geographically aggregated values. 
This is here done by weighting by the cumulative length of the anadromous part of each river system. 
Estimates of anadromous river length in kilometres are thus added to the main dataframe (`salmon`).

```{r}
{
  correction <- 5 
  # This is a factor correcting for the fact that tributaries are narrower than the 
  # main river. The value is comparatively arbitrary. It only affects the figure.

  salmon$Lengde <- NA  # total anadromous length of the river system
  salmon$HovElv <- NA  # appx. length of the anadromous part of the main river
  vassdrag$BekkeAreal <- sapply(vassdrag$BekkeAreal, max, 0)
  vassdrag$HovedelvAreal <- vassdrag$ElveAreal - vassdrag$BekkeAreal
  for (i in 1:nrow(salmon)) {
    w <- which(vassdrag$VassdragsNr == salmon$Vnr[i])
    if (length(w)) {
      salmon$Lengde[i] <- round(vassdrag$AnadromLengde[w] / 1000, 2) # kilometres
      salmon$HovElv[i] <- round(vassdrag$AnadromLengde[w] * min(1,
                                vassdrag$HovedelvAreal[w] / 
                               (vassdrag$HovedelvAreal[w] +
                                vassdrag$BekkeAreal[w] * correction)), -2) # metres
    }
  }
  
  print(summary(salmon$Lengde))
  
  # Predict missing values based on spawning biomass
  w <- which(is.na(salmon$Lengde))
  if (length(w)) {
    KG <- ln(salmon$Gytekg)
    KM <- ln(salmon$Lengde)
    salmon$Lengde[w] <- round(exp(predict(lm(KM ~ KG, subset = KG > 0), 
                                  newdata = data.frame(KG = KG[w]))), 2)
    salmon$HovElv[w] <- salmon$Lengde[w] * 1000
  }
}
```

There was only one missing value. 
It was replaced by an estimate predicted from the biomass of its target spawning stock.

The results can be shown on a map. 
For river systems where the stock quality is uncertain, it is represented by the mode of the simulated values. 

```{r}
#| lab: measurement-map
#| fig-cap: "Map of Norway with all salmon river systems. Colours indicate the overall salmon stock quality. For each river system, the (approximate) anadromous part of the main river is shown (i.e., tributaries are omitted)."

y <- accYears[length(accYears)]

par(mai = rep(0, 4))
plot(Norge.kontur, xlim = c(3.5, 31.5), ylim = c(57.5, 71.5), 
     xaxs = "i", yaxs = "i", asp = 2, col = grey(0.72), border = NA)

for (i in which(salmon$Vnr %in% elv$nbfVassNr)) {
  w <- which(elv$nbfVassNr == salmon$Vnr[i])[1]
  E <- elv$geometry[[w]][[1]]
  E <- E[order(E[, 4]), ]
  km <- nrow(E)
  if (as.numeric(elv$vassomr[w])       <= 26     & E[1, 2] > E[km, 2]) E <- snu(E)
  if (as.numeric(elv$vassomr[w]) %mellom% 27:174 & E[1, 1] > E[km, 1]) E <- snu(E)
  if (as.numeric(elv$vassomr[w])          >= 175 & E[1, 2] < E[km, 2]) E <- snu(E)
  km <- 1:max(which(E[, 4] < max(25000, salmon$HovElv[i])))
  lines(E[km, 1], E[km, 2], lwd = 2, 
        col = farge(as.numeric(mode(IndCat[i, y, -nsim]))))
}
for (i in seq(0.1, 0.9, 0.2)) {
  rect(21, 61 + (i - 0.1) * 6, 23, 61 + (i + 0.1) * 6, col = farge(i), lwd = 2)
}
text(23, 61 + 0.1 * 6, "bad", pos = 4)
text(23, 61 + 0.3 * 6, "poor", pos = 4)
text(23, 61 + 0.5 * 6, "moderate", pos = 4)
text(23, 61 + 0.7 * 6, "good", pos = 4)
text(23, 61 + 0.9 * 6, "high", pos = 4)
text(6, 70, "salmon\nstock\nquality", cex = 1.5, font = 2)
```

We can now estimate national indicator values.

```{r}
IND <- array(0, c(length(accYears), length(Qnt), 2),
             list(accYears, "Q" %+% Qnt, c("categorical", "continuous")))
for (y in accYears) {
  IND[y,,1] <- quantile(apply(IndCat[ ,y,], 2, weighted.mean, salmon$Lengde), Qnt)
  IND[y,,2] <- quantile(apply(IndCont[,y,], 2, weighted.mean, salmon$Lengde), Qnt)
}
print(round(IND, 4))
```

Categorical and continuous scores are shown alongside each other. 
"Categorical" means that the indicator is the weighted average of the categorical quality scores assigned to each river (accounting for uncertainty); 
whereas "continuous" means that the indicator is the weighted average of the continuous quality values for each river (including uncertainty). 
For the reasons discussed [above](#description-of-the-workflow), only the indicator values following the *continuous* definition are reported as results. 
The continuous indicator values turn out to be slightly higher than the categorical ones. 
This is not so be necessity but indicates that the "true" (or unrounded) indicator values for the rivers are, on average, somewhat above the midpoints of the intervals corresponding to their respective quality categories.

In order to estimate regional indicator values, we define a new variable for the region of Norway (*landsdel*) in which the river system is situated. 
This is inferred from the ID number of the respective river system (*vassdragsnummer*).

```{r}
# Defining a column for the region of Norway, 
# based on the river system ID ("vassdragsnummer")
salmon$ldel <- NA
omr <- as.numeric(substr(salmon$Vnr, 1, 3))
salmon$ldel[omr %mellom%   1:15]  <- "Ø"
salmon$ldel[omr %mellom%  16:26]  <- "S"
salmon$ldel[omr %mellom%  27:91]  <- "V"
salmon$ldel[omr %mellom%  92:143] <- "M"
salmon$ldel[omr %mellom% 144:306] <- "N"
salmon$ldel[omr %mellom% 307:309] <- "M"
salmon$ldel[omr %mellom% 310:315] <- "Ø"
rm(omr)
```

We can now estimate regional indicator values. 
The ones printed are for 2024.

```{r}
y <- accYears[length(accYears)]
regions <- array(0, c(6, length(Qnt), 2), list(c("WholeCountry", "Østlandet", 
                    "Sørlandet", "Vestlandet", "Midt-Norge", "Nord-Norge"),
                    "Q" %+% Qnt, c("categorical", "continuous")))
regions["WholeCountry", , 1] <- quantile(apply(IndCat[ , y, ], 2, weighted.mean, 
                                               salmon$Lengde), Qnt)
regions["WholeCountry", , 2] <- quantile(apply(IndCont[, y, ], 2, weighted.mean, 
                                               salmon$Lengde), Qnt)
for (L in rownames(regions)[-1]) {
  w <- which(salmon$ldel == substr(L, 1, 1))
  regions[L, , 1] <- quantile(apply(IndCat[ w, y, ], 2, weighted.mean, 
                                    salmon$Lengde[w]), Qnt)
  regions[L, , 2] <- quantile(apply(IndCont[w, y, ], 2, weighted.mean, 
                                    salmon$Lengde[w]), Qnt)
}
print(round(regions, 4))
```

<!--# 
Use this header for documenting the analyses. Put code in separate code chunks, and annotate the code in between using normal text (i.e. between the chunks, and try to avoid too many hashed out comments inside the code chunks). Add subheaders as needed. 

Code folding is activated, meaning the code will be hidden by default in the html (one can click to expand it).

Caching is also activated (from the top YAML), meaning that rendering to html will be quicker the second time you do it. This will create a folder inside you project folder (called INDICATORID_cache). Sometimes caching created problems because some operations are not rerun when they should be rerun. Try deleting the cash folder and try again.
-->


## 10. Results

The indicator is reported in terms of *scaled* indicator values (and following its *continuous* definition) only. 
The results are here tabulated (a) for the whole country and different years, and (b) for regions in 2024.


| Year | Best estimate | Lower quartile | Upper quartile |
|:-----|:-------------:|:--------------:|:--------------:|
| 2024 | 0.293         | 0.290          | 0.295          |
| 2021 | 0.319         | 0.316          | 0.322          |
| 2018 | 0.345         | 0.342          | 0.348          |

: Salmon stock indicator values for Norwegian rivers in different years {.striped .hover}

&nbsp;

| Region     | Best estimate | Lower quartile | Upper quartile |
|:-----------|:-------------:|:--------------:|:--------------:|
| Østlandet  | 0.575         | 0.563          | 0.587          |
| Sørlandet  | 0.538         | 0.531          | 0.545          |
| Vestlandet | 0.395         | 0.391          | 0.400          |
| Midt-Norge | 0.235         | 0.228          | 0.243          |
| Nord-Norge | 0.237         | 0.233          | 0.240          |

: Salmon stock indicator values in rivers for regions of Norway in 2024 {.striped .hover}

<!--# 
Repeat the final results here. Typically this is a map or table of indicator values.

This is typically where people will harvest data from, so make sure to include all relevant output here, but don't clutter this section with too much output either.
-->

<!--# 
## 11. Export file

Optional: Display the code (don't execute it) or the workflow for exporting the indicator values to file. Ideally the indicator values are exported as a georeferenced shape or raster file with indicators values, reference values and errors. You can also chose to export the raw (un-normalised or unscaled variable) as a seperate product. You should not save large sptaial output data on GitHub. You can use eval=FALSE to avoid code from being executed (example below - delete if not relevant) 
-->

```{r export}
#| eval: false
```
