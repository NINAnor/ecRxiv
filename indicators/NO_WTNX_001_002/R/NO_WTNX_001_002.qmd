---
title: "Total nitrogen"
subtitle: |
  [NO_WTNX_001] (rivers) \
  [NO_WTNX_002] (lakes)
format: 
  html:
    embed-resources: true
    code-fold: true
    toc: true
    toc-title: Contents
    toc-depth: 3
    smooth-scroll: true
execute: 
  cache: true
author:
  - name: Hanno Sandvik
    email: hanno.sandvik@nina.no
    affiliations:
      - id: myID
        name: Norwegian Institute for Nature Research
date: September 5, 2025 
callout-icon: false
lightbox: true
css: ../../../style.css
code-links:
      - text: Add a review
        icon: github
        href: https://github.com/NINAnor/ecRxiv
---

<!--# This is a template for how to document the indicator analyses. Make sure also to not change the order, or modify, the headers, unless you really need to. This is because it easier to read if all the indicators are presented using the same layout. If there is one header where you don't have anything to write, just leave the header as is, and don't write anything below it. If you are providing code, be careful to annotate and comment on every step in the analysis. Before starting it is recommended to fill in as much as you can in the metadata file. This file will populate the initial table in your output.-->

<!--# Load all you dependencies here -->

```{r setup}
#| include: false
library(knitr)
library(tidyverse)
library(kableExtra)
library(here)
knitr::opts_chunk$set(echo = TRUE)

library(foreign)
library(sf)
library(readxl)
library(httr)
library(jsonlite)
library(sp)
```

```{r source}
#| echo: false
source(here::here("_common.R"))
```

```{r}
#| echo: false
meta <- readxl::read_xlsx("../metadata.xlsx")
st <- meta |>
  filter(Variable == "status") |>
  pull(Value)
version <- meta |>
  filter(Variable == "Version") |>
  pull(Value)
auth <- meta |>
  filter(Variable == "authors") |>
  pull(Value)
year <- meta |>
  filter(Variable == "yearAdded") |>
  pull(Value)
id <- meta |>
  filter(Variable == "indicatorID") |>
  pull(Value)
name <- meta |>
  filter(Variable == "indicatorName") |>
  pull(Value)
url <- meta |>
  filter(Variable == "url") |>
  pull(Value)

meta <- meta |>
  mutate(Variable = case_match(Variable,
    "indicatorID" ~ "Indicator ID" ,
    "indicatorName" ~ "Indicator Name",
    "country" ~ "Country",
    "continent" ~ "Continent",
    "ECT" ~ "Ecosystem Condition Typology Class",
    "yearAdded" ~ "Year added",
    "yearLastUpdate" ~ "Last update",
    .default = Variable
   )
  ) |>
  filter(Variable != "authors")

```

<!--# The following parts are autogenerated. Do not edit. -->

```{r}
#| echo: false
#| results: asis
status(st)
```

> **Recomended citation, indicator 1**: `r paste("\n", auth, " ", year, ". ", name, " (ID: ", id[1], ") ", "v. ", version, ". ecRxiv: ", url, sep="")`

> **Recomended citation, indicator 2**: `r paste("\n", auth, " ", year, ". ", name, " (ID: ", id[2], ") ", "v. ", version, ". ecRxiv: ", url, sep="")`

> **Version**: `r version`

```{=html}
<details>
<summary>Show metadata</summary>
```

```{r tbl-meta}
#| tbl-cap: 'Indicator metadata'
#| echo: false
#| warning: false

meta |>
  select(Variable, Value) |>
  kbl(col.names = NULL) 

```

```{=html}
</details>
```

::: {.callout-tip collapse="true"}

## Logg

<!--# Update this logg with short messages for each update -->
- 12 May 2025 - Version 000.900 started
:::


<hr />

<!--# Document you work below.  -->

## 1. Summary

Freshwater ecosystems are negatively affected by anthropogenic activities that change the chemical composition of the water, such as pollution or run-off causing eutrophication. 
Nitrogenous compounds, summarised as total nitrogen, are a contributing factor of eutrophication. 
Therefore, the total nitrogen concentration in lakes and rivers may be an indicator of their eutrophication. 

"Total nitrogen" (TN) is a measure of all nitrogen in a water sample. 
As such it includes inorganic nitrogen (i.e. nitrate, nitrite and ammonia/ammonium) as well as organic nitrogen (e.g. amines, proteins and urea).

Total nitrogen is one of the indicators that is measured and reported in connection with the [*Water Framework Directive*](#wfd) (hereafter **WFD**). 
In Norway, the WFD is implemented by means of [*Vannforskriften*](#vannf), and relevant indicators ("parameters", in WFD terminology) are described in national guidelines ([DGVF 2025](#veil2)). 
The data collected are archived and made available in the [*Vannmiljø*](https://vannmiljo.miljodirektoratet.no/) database. 

These WFD data can be used in other contexts, including ecosystem condition accounts. 
The procedure implemented here consists of the following steps:

* Selecting measurements from the relevant time period.
* Removing measurements that do not fulfil the requirements for the specific indicator.
* Identifying the water body for each measurement.
* Fitting a linear model to the measurements, with explanatory variables being typology factors of the water bodies, reporting periods, and surveillance activities.
* Averaging measurements taken in the same water body.
* Extrapolating variable values to water bodies that lack data, based on the model fitted.
* Using simulations to estimate confidence and prediction intervals.
* Aggregating estimates geographically using area-weighted averages.

> ### Interpretation
Variable values are not easily interpretable ecologically, which is why the indicator is deprecated. Generally, low variable values signify conditions where there is little or no human impact on the water body, whereas high variable values may reflect negative ecological change, specifically eutrophication. However, what can be regarded as low or high varies among water body types and depends on the concentration of other nutrients.

<!--# 
With a maximum of 300 words, describe the indicator in general terms as you would to a non-expert. Think of this as a kind of commmon language summary. It is a good idea to include a bullet point list of the spesific steps in the workflow. Include a mention of the following aspects:

What does the metric represent?
Why is this relevant for describing ecosystem condition in this ecosystem?
What are the main anthropogenig impact factors?
What kind of data is used? 
Shortly, how is the data customized (modified, estimated, integarted) to fit its purpuse as an indicator?
What is the current status of  the metric (can it be used or is it still in development)?
How should the metric be used and interpretted, and how should it not be used/interpretted?
-->


## 2. About the underlying data

WFD data in Norway are collected in a common database called [*Vannmiljø*](https://vannmiljo.miljodirektoratet.no/), which is maintained by the [Norwegian Environment Agency](https://www.miljodirektoratet.no/). 
This database contains information on all *measurements* taken in connection with the WFD ("registrations") as well as all *locations* at which measurements are taken ("water localities"). 
Each water locality is assigned to a *water body*. 
Information on water bodies can be retrieved from two other databases: the typology of water bodies is available from [*Vann-nett*](https://vann-nett.no/), whereas a geospatial dataset can be [downloaded](https://karteksport.miljodirektoratet.no/) from the Norwegian Environment Agency.
Finally, detailed information on Norwegian lakes is available from the [*Innsjødatabase*](https://www.nve.no/kart/kartdata/vassdragsdata/innsjoedatabase/), which is maintained by the [Norwegian Water Resources and Energy Directorate](https://www.nve.no/).

<!--# Describe the data you have used in more detail, it's origin, biases, availability ect.-->

### 2.1 Spatial and temporal resolution and extent

The **spatial** resolution of WFD indicators is on the level of *water bodies*. 
The WFD defines a water body (specifically a "body of surface water") as "a discrete and significant element of surface water such as a lake, a reservoir, a stream, river or canal, [or] part of a stream, river or canal" (WFD, Article 2, paragraph 10; cf. *Vannforskriften* §&nbsp;3, letter a; for implementation, see [DGVF 2018](#veil1), ch. 2).

There is no specific **temporal** resolution, as measurements of WFD indicators are reported sporadically. 
Some water bodies are sampled regularly (e.g., every fifth year). 
For most water bodies, however, no such fixed surveillance schemes exist. 
Still, the total amount of measurements for many WFD indicators is sufficient to estimate annual values that are spatially aggregated to the national and regional level.

A specific requirement for total nitrogen is that the indicator value for a given water body in a given year is to be based on annual averages of measurements that are taken at least monthly throughout the growing season (June--September in Northern Norway and May--October in the rest of Norway; [DGVF 2025](#veil2)).

<!--# Describe the temporal and spatial resolution and extent of the data used -->

### 2.2 Original units

Total nitrogens is the sum of inorganic nitrogen (i.e. nitrate NO~3~^&minus;^, nitrite NO~2~^&minus;^ and ammonia NH~3~ / ammonium NH~4~^+^) and organic nitrogen (e.g. amines, proteins and urea CH~4~N~2~O). 
The total nitrogen concentration in water is measured in µg/L.

<!--# What are the original units for the most relevant  variables in the data-->

### 2.3 Additional comments about the dataset

#### 2.3.1 Instructions for citing, using and accessing data

All data used are publicly available. 
However, with the exception of [*Vannmiljø*](https://vannmiljowebapi.miljodirektoratet.no/swagger/ui/index#/), they are not accessible via an API but need to be downloaded manually. 
Some required files are currently unavailable from from *Vann-nett* (temporarily so, it seems); they are therefore read from a previous *Vann-nett* download, which is archived in the GitHub repo [WFD2ECA](https://github.com/NINAnor/WFD2ECA/). 
For further details, see [Datasets](#datasets) below.

<!--# Is the data openly available? If not, how can one access it? What are the key references to the datasets?   -->


## 3. Indicator properties

Total nitrogen has the ID **83** in the metadata table for ecological condition variables for use in Norway ([Czúcz et al. 2023](#czu23)).

### 3.1 Ecosystem Condition Typology Class (ECT)

The ECT of total nitrogen is **A2** (chemical state) because the indicator is defined as the concentration of chemical compounds.

<!--# 
Describe the rationale for assigning the indicator to the ECT class. See https://oneecosystem.pensoft.net/article/58218/
This doesnt need to be very long. Maybe just a single sentence. 
-->

### 3.2 Ecosystem condition characteristic

Intact freshwater ecosystems are characterised by having relatively low total nitrogen concentrations, and high levels are the cause of eutrophication.

<!--# 
Describe the ecosystem condition characteristic represented in the indicator. See 10.3897/oneeco.6.e58218 for information on what these characteristics might be.
For example, and indicator called 'Trenching in mires' could be made to represent an ecosystem characteristic 'Intact hydrology'. The term 'characteristic' is used similar to the term 'criteria' in Multiple Criteria Decition Making.  
-->

### 3.3 Other standards

In the Norwegian classification of ecological characteristics (*økologiske egenskaper*) according to Nybø & Evju ([2017](#nyb17), p. 35), the indicator represents **abiotic conditions** (*abiotiske forhold*).

In the WFD's distinction between **quality elements**, the indicator belongs to the *supporting chemical and physico-chemical elements*, representing **nutrition** (WFD, Annex&nbsp;V).

Eurostat has listed total nitrogen as a **voluntary condition variable** for reporting in connection with the EU Regulation 2024/3024 ([EU 2024](#eu24), Annex&nbsp;IX; cf. [Czúcz el at. 2025](#czu25)).

<!--# Optional: Add text about other spesific standards, e.g. national standards, and how the indicator relates to these -->

### 3.4 Collinearities with other indicators

Total nitrogen may be broadly correlated to other measures of river and lake eutrophication, such as
[ASPT](https://github.com/NINAnor/ecRxiv/tree/main/indicators/NO_WSPT_001),  [chlorophyll&nbsp;*a*](https://github.com/NINAnor/ecRxiv/tree/main/indicators/NO_WCHL_001), 
[phytoplankton biomass](https://github.com/NINAnor/ecRxiv/tree/main/indicators/NO_WPPB_001), 
[PIT](https://github.com/NINAnor/ecRxiv/tree/main/indicators/NO_WPIT_001), 
[PTI](https://github.com/NINAnor/ecRxiv/tree/main/indicators/NO_WPTI_001) and 
[total phosphorus](https://github.com/NINAnor/ecRxiv/tree/main/indicators/NO_WTPX_001_002).

<!--# Describe known collinearities with other metrices (indicators or variables) that could become problematic if they were also included in the same Ecosystem Condition Assessment as the indicator described here. -->

### 3.5 Impact factors

Total nitrogen concentration is a cause of eutrophication.
A natural source is the decay of plant matter in soils. 
Anthropogenic sources of nitrogen include local or up-stream run-off (e.g. from fertilised lawns or croplands and livestock manure) or direct pollution (e.g. from wastewater treatment).

<!--# Describe the main natural and anthropogenic factors that affecst the metric -->


## 4. Reference condition and levels

### 4.1 Reference condition

The WFD defines the reference condition of a water body as "the condition of a quality element where there is little or no human impact on the water body. The reference condition is therefore also referred to as the natural condition" ([DGVF 2025](#veil2)).

Reference conditions may be specific to certain water-body types. 
Water bodies judged to be in the reference condition are referred to as *reference water bodies*.

<!--# Define the reference condition (or refer to where it is defined). Note the distinction between reference condition and reference levels 10.3897/oneeco.5.e58216  -->

### 4.2 Reference levels

According to the WFD, reference levels are defined for X~0~, X~20~, X~40~, X~60~, X~80~, and X~100~. 
These are used to classify the "ecological status" of water bodies as "bad" (X~0~ &le; X &le; X~20~), "poor" (X~20~ < X &le; X~40~), "moderate" (X~40~ < X &le; X~60~), "good" (X~60~ < X &le; X~80~), and "high" (X~80~ < X &le; X~100~). 

Reference levels for total nitrogen are provided in Table 7.10 of DGVF ([2025](#veil2)) for lakes and rivers, respectively. 
However, the same guidelines make it clear that these reference levels only apply to water bodies that are nitrogen-limited ([DGVF 2025](#veil2)). 
Nitrogen limitation can occur when the ratio between total nitrogen and total phosphorus is lower than 20, a condition that is normally met only in heavily eutrophicated water bodies. 

As these conditions are rare in Norway, total nitrogen is not normally an informative indicator of the ecological status of freshwater. 
Calculation of nEQR (or indicator) values would therefore be misleading. 
At the same time, total nitrogen is a variable recommended for ecosystem condition accounting by Eurostat (see [Czúcz et al. 2025](#czu25)). 
As a compromise, total nitrogen is here -- hesitatingly -- reported as an *unscaled variable* (in original units), rather than as a scaled indicator. 
It is important to be aware, however, that the values reported thus *cannot* be transformed into indicator values sensu SEEA&nbsp;EA and *must not* be interpreted as directly indicating ecosystem condition.

<!--# 
If relevant (i.e. if you have normalised a variable), describe the reference levels used to normalise the variable. 

Use the terminology where X~0~ refers to the reference level (the variable value) denoting the worst possible condition; X~100~denotes the optimum or best possible condition; and X~*n*~, where in is between 0 and 100, denotes any other anchoring points linking the variable scale to the indicator scale (e.g. the threshold value between good and bad condition X~60^). 

Why was the current option chosen and how were the reference levels quantified? If the reference values are calculated as part of the analyses further down, please repeat the main information here.
-->

#### 4.2.1 Spatial resolution and validity

The spatial resolution of WFD reference levels is the water body. 
Reference levels of total nitrogen differ between water body types (but see above on the limited value of reference levels for this indicator).

<!--# 
Describe the spatial resolution of the reference levels. E.g. is it defined as a fixed value for all areas, or does it vary. Also, at what spatial scale are the reference levels valid? For example, if the reference levels have a regional resolution (varies between regions), it might mean that it is only valid and correct to use for normalising local variable values that are first aggregated to regional scale. However, sometimes the reference levels are insensitive to this and can be used to scale variables at the local (e.g. plot) scale. 
-->


## 5. Uncertainties

The main uncertainty for national and regional values of the indicator is *sampling error*. 
Measurements of variable values are only sampled in a small fraction of all relevant water bodies. 
The approach below extrapolates indicator values to water bodies that have not been sampled, but this extrapolation is necessarily uncertain. 
This uncertainty is quantified using prediction intervals.

The underlying problem of the mentioned uncertainty is that the *representativeness* of the sampled water bodies for the non-sampled water bodies is unknown. 
A specific issue regarding representativeness is that quite some WFD measurements are taken *precisely because the sampled water body is known or assumed to be unrepresentative*. 
The main reasons are the following:

* Some water bodies are sampled because it is known or suspected that they do not fulfil the normative objective that X > X~60~ (in order to justify and design measures to improve ecological condition and, later, to evaluate the effect of the measures taken).
* Some water bodies are sampled because they are regarded as reference water bodies, i.e. assumed to be in, or very close to, the reference condition.

The approach below attempts to correct for these biases by weighting measurements by the "surveillance activity" (*overvåkingsaktivitet*) during which they have been sampled. 
Scores between &minus;3 and +3 have been assigned to each surveillance activity, where the sign indicates the direction of the deviation (poorer or better than a randomly chosen water body), and the absolute value is an estimate of the magnitude of the bias. 
The approach has been described (in Norwegian) by Sandvik ([2019](#san19): pp. 17--19) and extended by Framstad et al. ([2023](#fra23): pp. 121--122).

<!--# Describe the main uncertainties or sources of error in the indicator or the underlying data. -->


## 6. References

<span id="czu23">Czúcz B, Sandvik H, Framstad E & Schartau AK.</span> 2023. Metadata for ecological condition variables for use in Norway, version 1.0. [[doi:10.5281/zenodo.10187828](https://doi.org/10.5281/zenodo.10187828)]

<span id="czu25">Czúcz B, Framstad E, Clappe S & Nowell M.</span> 2025. Exploring the use of Eurostat's mandatory and voluntary indicators in Norway. *NINA Rep* **2604**: in press. [[hdl:11250/3199708](https://hdl.handle.net/11250/3199708)]

<span id="veil1">DGVF [Direktoratsgruppa for vannforvaltning].</span> 2018. *Veileder 1:2018 Karakterisering. Metodikk for å karakterisere og vurdere miljømålsoppnåelse etter vannforskriftens § 15.* Miljødirektoratet, Trondheim. <https://www.vannportalen.no/veiledere/veileder-12018-karakterisering-metodikk-fora-karakterisere-og-vurdere-miljooppnaelse-etter-vannforskriften--15/>

<span id="veil2">DGVF [Direktoratsgruppa for vannforvaltning].</span> 2025. *Veileder for klassifisering av miljøtilstand i kyst- og ferskvann* [version of 28 Jan 2025]. Vannportalen. <https://www.vannportalen.no/veiledere/klassifiseringsveileder/>

<span id="eu24">EU.</span> 2024. Regulation (EU) 2024/3024 of the European Parliament and of the Council of 27 November 2024 amending Regulation (EU) No 691/2011 as regards introducing new environmental economic account modules. [[CELEX:32024R3024](http://eur-lex.europa.eu/LexUriServ/LexUriServ.do?uri=CELEX:32024R3024:en:NOT)]

<span id="fra23">Framstad E, Czúcz B, Schartau AK, Simensen T, Nybø S & Sandvik H.</span> 2023. Naturregnskap og økologisk tilstand: Samsvar mellom fagsystemet for økologisk tilstand, vannforskriften, FNs rammeverk og EUs forslag til naturregnskap. *NINA Rapp* **2327**: 1--122. [[hdl:11250/3104185](https://hdl.handle.net/11250/3104185)]

<span id="nyb17">Nybø S & Evju M (eds).</span> 2017. *Fagsystem for fastsetting av god økologisk tilstand. Forslag fra et ekspertråd.* Klima- og miljødepartementet, Oslo. <https://www.regjeringen.no/no/dokumenter/fagsystem-for-fastsetting-av-god-okologisk-tilstand/id2558481/>

<span id="san19">Sandvik H.</span> 2019. Ferskvann i vannforskriften og naturindeksen. Forslag til samordning og dataflyt. *NINA Rapp* **1723**: 1--38. [[hdl:11250/2631056](http://hdl.handle.net/11250/2631056)]

<span id="san25">Sandvik H.</span> 2025. WFD2ECA: Dataflyt fra vannforskriften til økologisk tilstandsregnskap og naturindeks, version 2.0. <https://github.com/NINAnor/WFD2ECA> [[doi:10.5281/zenodo.10278000](https://doi.org/10.5281/zenodo.10278000)]

<span id="seeaea">**SEEA EA**:</span> United Nations et al. 2024. *System of Environmental-Economic Accounting -- Ecosystem Accounting.* UN, New York. <https://seea.un.org/ecosystem-accounting>

<span id="vannf">**Vannforskriften**.</span> 2006. Forskrift om rammer for vannforvaltningen. *Nor Lovtid I* **2006**: 2004--2034. [[FOR-2006-12-15-1446](https://lovdata.no/dokument/SF/forskrift/2006-12-15-1446)]

<span id="wfd">**WFD**:</span> EU. 2000. Directive 2000/60/EC of the European Parliament and of the Council of 23 October 2000 establishing a framework for Community action in the field of water policy. *Off J EU L* **43** (327): 1--72. [[CELEX:32000L0060](http://eur-lex.europa.eu/LexUriServ/LexUriServ.do?uri=CELEX:32000L0060:en:NOT)]
  
<!--# You can add references manually or use a citation manager and add intext citations as with crossreferencing and hyperlinks. See https://quarto.org/docs/authoring/footnotes-and-citations.html -->


## 7. Datasets

<!--# Describe the unique datasets seperately under seperate headers (Dataset A, Dataset B, etc.-->

### 7.1 Vannmiljø

*Vannmiljø* is a database maintained by the [Norwegian Environment Agency](https://www.miljodirektoratet.no/) that is used to collect registrations related to ecological condition of water according to the WFD. 
This database contains information on all *measurements* taken in connection with the WFD ("registrations") as well as all *locations* at which measurements are taken ("water localities"). 
Other information available from *Vannmiljø* includes lists of WFD variables and indicators ("parameters"), of surveillance activities, of measurement units used, of species recorded etc. 

The database has long been available for manual download via [https://vannmiljo.miljodirektoratet.no](https://vannmiljo.miljodirektoratet.no/). 
Recently, the data have also been made available via an [API](https://vannmiljowebapi.miljodirektoratet.no/swagger/ui/index#/), which is utilised here. 

<!--# Describe the main dataset, typicaly the one containing the variable of (most) interest. Change the header from Dataset A to the name of the actual dataset. -->

### 7.2. Vannforekomster

In order to carry out the subsequent analyses, all WFD registrations need to be assigned to the correct water body (*vannforekomst*). 
Information on water bodies has currently to be downloaded from separate sources. 
A geospatial dataset of all water bodies is publicly available, but it needs to be downloaded manually:

* Navigate to [https://karteksport.miljodirektoratet.no](https://karteksport.miljodirektoratet.no/).
* In the menu to the left of the map, tick "Vannforekomster" in the "Produkt" section...
* ...and "Nasjonalt" in the "Definer område" section.
* Click "Neste".
* Provide your e-mail in the "Epost" box.
* Choose "ESRI Filgeodatabase (ESPG:4326)" in the "Format" box.
* Upon pressing "Send bestilling", a compressed geodatabase (gdb) will be sent to your e-mail.

The uncompressed geodatabase is needed for the analyses. 
It has to have the name "VF.gdb" and to be placed in the "data" folder in order to be recognised. 
(A cached version called "VF.RData" is used in the demo below.)

### 7.3. Vann-nett

In addition to the location of water bodies, the subsequent analyses need information on the water body *typology*. 
In WFD context, typology refers to a set of factors describing abiotic characteristics of the water bodies, such as altitude, size and alkalinity. 
This information is publicly available from a separate database called *Vann-nett* via the link [https://vann-nett.no/waterbodies/report](https://vann-nett.no/waterbodies/report). 

A spreadsheet workbook exported from *Vann-nett* is needed for the analyses. 
It has to have the name "V-L.csv" (for lakes) or "V-R.csv" (for rivers) in order to recognised.

*(Note that Vann-nett has recently been upgraded. In the new version, typology factors are not included in the list of variables about water bodies that are available for export. For the time being, water body typology thus has to be based on an export from the previous version of Vann-nett, which is no longer online. It is to be hoped that the relevant information will be made available in the new version soon.)* <!--# 
I have requested this information to be added. I hope that it is only a matter of time before it is available again. -->

### 7.4. Innsjødatabasen

Detailed information on Norwegian lakes is available from the [*innsjødatabase*](https://www.nve.no/kart/kartdata/vassdragsdata/innsjoedatabase/) ("lake database") maintained by the Norwegian Water Resources and Energy Directorate ([NVE](https://www.nve.no/)). 
This dataset is publicly available, but it needs to be downloaded manually:

* Navigate to [https://nedlasting.nve.no/gis/](https://nedlasting.nve.no/gis/).
* Choose (or retain) "Vektordata" in the "Velg datatype" dropdown menu.
* Expand the "Innsjø" heading.
* Tick the "Innsjø" box.
* Click "Neste".
* Choose "ESRI shapefil (.shp)" in the "Velg kartformat" dropdown menu.
* Choose "Geografiske koordinater ETRS89" in the "Velg koordinatsystem" dropdown menu.
* Choose "Overlapper" in the "Velg utvalgsmetode" dropdown menu.
* Choose "Landsdekkende" in the "Velg dekningsområde" dropdown menu.
* Click "Neste".
* Provide your e-mail address in the "E-post" boxes.
* Tick the "Jeg har lest og forstått betingelser..." box to accept the terms of use.
* Upon pressing "Send", a link to a compressed archive (zip) will be sent to your e-mail.
* Click that link to download the data.
* Uncompress the zip archive. (Upon uncompression, the relevant files are located in the folder `NVEKartdata\NVEData\Innsjo`.)
* Place the shapefiles (called `Innsjo_Innsjo.*`) in the "data" folder.

(A cached version called "NVE.RData" is used in the demo below.)

<!--# Describe additional datasets in a similar was as above. Delete or add ned subheaders as needed. -->


## 8. Spatial units

Data (measurements) are assumed to be representative for their respective water bodies, which correspond to the Ecosystem Assets of freshwater ecosystems. 
The Ecosystem Accounting Area covered by the data is mainland Norway. 

<!--# 
Describe the spatial units that you rely on in your analyses. Highlight the spatial units (the resolution) that the indicator values should be interpretted at. Potential spatial delineation data should eb introduced under 7.1. Datasets. We recomend using the SEEA EA terminology opf Basic Spatial Units (BSU), Ecosystem Asses (EA) and Ecosystem Accounting Area (EAA). 
-->

## 9. Analyses

### 9.1. Preliminaries

At the outset, we define two variables containing the official abbreviations (i.e., according to *Vannmiljø*) of the indicator and of the relevant water category, respectively. 
("Water categories" are **R**iver, **L**ake and **C**oast.)

```{r}
indikator <- tittel <- "N-TOT"
vannkategori <- c("L", "R")
```

The dataflow used here follows partly the one that has been described in the GitHub repository [WFD2ECA](https://github.com/NINAnor/WFD2ECA/). 
We start by downloading the functions and data files from archived version 2.0 of that repo.

```{r}
if(!file.exists("../data/VF.RData")) {
  download.file("https://zenodo.org/records/16811526/files/NINAnor/WFD2ECA-v2.0.zip",
                "../data/WFD2ECA.zip")
  folder <- "../data/WFD2ECA"
  unzip("../data/WFD2ECA.zip", exdir = folder)
  while (length(list.files(folder)) == 1) {
    folder <- paste0(folder, "/", list.files(folder))
  }
  whichDataFile <- c(
    "fnr.xlsx",
    "knr.xlsx",
    "navnNVEl.csv",
    "navnVL.csv",
    "navnVM.csv",
    "navnVN.csv",
    "NVE.RData",
    "Norge.map",
    paste0("V-", vannkategori, ".csv"),
    "VF.RData",
    "VM-aktiv.xlsx",
    "VM-param.xlsx"
  )
  dummy <- file.copy(from = paste0(folder, "/data/", whichDataFile),
                     to   = "../data/",
                     overwrite = FALSE)
  #dummy <- file.copy(from = paste0(folder,
  #                                 "/klassegr/klassegrenser_",
  #                                 indikator, 
  #                                 ".xlsx"),
  #                   to   = "../data/",
  #                   overwrite = FALSE)
  dummy <- file.copy(from = list.files(paste0(folder, "/R/"), full.names = TRUE),
                     to   = ".",
                     overwrite = FALSE)
  dummy <- file.remove("../data/WFD2ECA.zip")
  unlink("../data/WFD2ECA", recursive = TRUE)
}
```

Next, we load the functions contained in that repo.

```{r}
source("Funksjon.R")
for (filnavn in list.files(".", full.names = TRUE)) {
  if (substr(filnavn, nchar(filnavn), nchar(filnavn)) %=% "R") {
    source(filnavn)
  }
}
```

### 9.2. Reading data on water bodies

The preparation of the list of water bodies (*vannforekomster*) requires three files: 
two containing the water body typologies, which need to be downloaded from *Vann-nett* and named "V-L.csv" and "V-R.csv" (for **L**ake and **R**iver water bodies, respectively); 
and another file containing a geodatabase of all water bodies, named "VF.gdb".

```{r, eval=FALSE, echo=TRUE}
V <- lesVannforekomster(vannkategori)
```
```{r, eval=TRUE, echo=FALSE}
# The geodatabase is too huge for GitHub, so a cached version is used instead
V <- lesVannforekomster(vannkategori, CACHE = "VF.RData")
```

The output informs us of several adjustments made to the data, but that the operation was successful and how many water bodies (of the relevant water category) there are.

The export from *Innsjødatabase* needs to be read, too.

```{r, eval=FALSE, echo=TRUE}
nve <- lesInnsjodatabasen("Innsjo_Innsjo.dbf")
```
```{r, eval=TRUE, echo=FALSE}
# The shapefile is too huge for GitHub, so a cached version is used instead
nve <- lesInnsjodatabasen("Innsjo_Innsjo.dbf", CACHE = "NVE.RData")
```

The output informs us of a few adjustments made to the data, but that the operation was successful.

The information on water bodies (from *Vann-nett*) needs to be coupled with the information about lakes (from *Innsjødatabasen*). 
This step also checks for some potential errors.

```{r}
V <- oppdaterVannforekomster(V, nve)
```

Again, the output informs us of some adjustments made to the data, but that the operation was successful.

### 9.3. Reading registrations and other information from Vannmiljø

Now we read the measurements of the specified indicator from the *Vannmiljø* API.

```{r}
{
  DATA <- lesMaalinger(indikator)
  
  # As we will later use log-transformation, values of 0 are replaced by 0.01
  # (a very small but arbitrary value)
  DATA$verdi <- sapply(DATA$verdi, max, 0.01)
}
```

The output informs us that the operation was successful and how many registrations have been read.

A list of water localities (*vannlokaliteter*) is likewise read from the *Vannmiljø* API. 
The main function argument is the water category.

```{r}
VL <- lesVannlokaliteter(vannkategori)
```

The output informs us that the operation was successful and how many water localities there are.

We can show the raw (unfiltered and unscaled) measurements on a map.

```{r}
#| lab: measurement-map
#| fig-cap: "Map of Norway with points for all water bodies in which the indicator has been recorded. Colour indicates the average unscaled variable value for the water body."

{
  xaxis <- seq(0, 500, 100)
  dig <- 0
  snudd <- TRUE
  
  ml <- V[which(V$id %in% 
               VL$id[which(VL$lokid %in% 
                         DATA$lokid[which(DATA$verdi %mellom% range(xaxis))])]), ]
  ml$maaling <- NA
  for (i in 1:nrow(ml)) {
    ml$maaling[i] <- mean(DATA$verdi[which(DATA$lokid %in% 
                                             VL$lokid[which(VL$id == ml$id[i])])])
  }
  z <- 2
  fjern <- c()
  while (length(which(ml$maaling < xaxis[z])) == 0) {
    fjern <- c(fjern, z - 1)
    z <- z + 1
  }
  z <- length(xaxis) - 1
  while (length(which(ml$maaling > xaxis[z])) == 0) {
    fjern <- c(fjern, z + 1)
    z <- z - 1
  }
  if (length(fjern)) xaxis <- xaxis[-fjern]
  if (snudd) xaxis <- rev(xaxis)
  xlim <- range(xaxis)
  ml$maaling <- sapply(sapply(ml$maaling, max, xlim[1]), min, xlim[2])
  ml <- ml[order(ml$maaling, decreasing = !snudd), ]
  
  load("../data/Norge.map")
  par(mai = rep(0, 4))
  plot(Norge.kontur, xlim = c(3.5, 31.5), ylim = c(57.5, 71.5), 
       xaxs = "i", yaxs = "i", asp = 2, col = grey(0.84), border = NA)
  points(ml$long, ml$lat, pch = 20, cex = 0.6, col = if (snudd)
         farve(ml$maaling, xlim[2], xlim[1]) else 
         farve(ml$maaling, xlim[1], xlim[2]))
  text(6, 70, tittel, cex = 1.5, font = 2)
  for (i in seq(0, 0.999, 0.001)) {
    rect(24, 59+i*8, 26, 59+(i+0.001)*8, border = NA,
         col = if (snudd) farve(i, 1, 0) else farve(i, 0, 1))
  }
  rect(24, 59, 26, 67, lwd = 2)
  for (i in xaxis) {
    lines(c(24.0,23.6), rep(59 + 8 * (i-xlim[1]) / (xlim[2]-xlim[1]), 2), lwd=2)
  }
  text(23.6, 59 + 8 * (xaxis - xlim[1]) / (xlim[2] - xlim[1]), 
       erstatt(formatC((xaxis), dig, format = "f"), "-", "−"), pos = 2)
  if (length(unique(DATA$enhet)) %=% 1 & 
             unique(DATA$enhet) %!=% "3" & exists("Enheter")) {
    text(25, 58.5, Enheter[which(Enheter[, 1] == unique(DATA$enhet)), 2])
  }
}
```

### 9.4. Calculating nEQRs using reference levels

According to the WFD and DGVF ([2025](#veil2)), measurements of WFD variables are transformed into so-called nEQR values ("normalised Ecological Quality Ratios") between 0 and 1, which correspond to indicator values sensu [SEEA&nbsp;EA](#seeaea). 
For the reasons mentioned [above](#reference-levels), this step cannot be performed for total nitrogen.

### 9.5. Estimating the variable values and their uncertainty

With the necessary files in place, the calculations can start. 
This is done using the function WFD2ECA ("Water Framework Directive to Ecosystem Condition Account"), which is [documented in the WFD2ECA repository](https://github.com/NINAnor/WFD2ECA/blob/main/forklar/dataflow.md) ([Sandvik 2025](#san25)). 
Note, however, that the normal dataflow needs to be adjusted to the fact that untransformed values of total nitrogen, rather than nEQR values, are used in model fitting, estimation and extrapolation.
This is accomplished by the function argument `EQR = FALSE`.

The function produces summaries of the steps performed (for the time being, the information is provided in Norwegian only). 
It has to be run separately for each water category, i.e. for rivers (`vannkategori = "R"`) and lakes (`vannkategori = "L"`). 
Here, the code illustrates a run for (a subset of) river water bodies.

```{r, eval=FALSE, echo=TRUE}
utmating <- WFD2ECA(
  DATA = DATA,
  vannforekomster = V,
  vannlokaliteter = VL,
  parameter = indikator,
  vannkategori = "R",
  EQR = FALSE,
  logit = "log",
  iterasjoner = 1000,
  SEED = 479001600,
  vis = FALSE
)
```
```{r, eval=TRUE, echo=FALSE}
# The entire dataset takes more than 2 hours to run.
# To save time, only the first 25,000 measurements are used.
# (The results tabulated in section 10 use the entire dataset!)
DATA = DATA[1:25000, ]

# To avoid messy output, the arguments "bredde" and "tell" are added
# This affects nothing but the layout
utmating <- WFD2ECA(
  DATA = DATA,
  vannforekomster = V,
  vannlokaliteter = VL,
  parameter = indikator,
  vannkategori = "R",
  EQR = FALSE,
  logit = "log",
  iterasjoner = 1000,
  SEED = 479001600,
  bredde = 90,
  vis = FALSE, # this simplifies/shortens the information displayed on screen
  tell = FALSE
)
```

### 9.6. Summary of the output

The output is a list with one list element per geographic reporting level (i.e., in this case, one for the national and one for the regional level).
For each geographical unit on this level and each reporting year, the predicted value and the simulated values are saved.

```{r}
{
  ut <- utmating
  attributes(ut) <- attributes(ut)[1:3]
  # to simplify the output, most attributes are removed
  str(ut)
  rm(ut)
}
```

The estimates and their confidence intervals may be summarised as tables.

```{r}
{
  kvantiler <- c(0.025, 0.25, 0.5, 0.75, 0.975)
  print(round(t(apply(utmating$Norge[  "Norge", , -1], 1, quantile, kvantiler)), 2))
  print(round(t(apply(utmating$landsdel[, "2024", -1], 1, quantile, kvantiler)), 2))
}
```

<!--# 
Use this header for documenting the analyses. Put code in separate code chunks, and annotate the code in between using normal text (i.e. between the chunks, and try to avoid too many hashed out comments inside the code chunks). Add subheaders as needed. 

Code folding is activated, meaning the code will be hidden by default in the html (one can click to expand it).

Caching is also activated (from the top YAML), meaning that rendering to html will be quicker the second time you do it. This will create a folder inside you project folder (called INDICATORID_cache). Sometimes caching created problems because some operations are not rerun when they should be rerun. Try deleting the cash folder and try again.
-->


## 10. Results

As the reference values defined for total nitrogen are not representative of Norwegian water bodies under normal conditions ([see above](#reference-levels)), *scaled* values (*indicator* values sensu SEEA&nbsp;EA) are not informative. 
Therefore, total nitrogen is reported in terms of *unscaled* values only (*variable* values sensu SEEA&nbsp;EA). 
These values *should not* be interpreted as indicating ecosystem condition.

The results are here tabulated (a) for the whole country and different years, and (b) for regions in 2024. 
These estimates are based on 10,000 iterations and therefore differ from the ones above.

*NB: Please note that these results are not the final ones for 2024. The deadline for reporting WFD measurements taken in 2024 is September 2025, meaning that the values for 2024 are so far based mainly on measurements taken in 2022 and 2023.* 


| Ecosystem  | Year | Best estimate | Lower quartile | Upper quartile |
|:----------:|:-----|--------------:|---------------:|---------------:|
| **Rivers** | 2024 | 133           | 131            | 134            |
| **Rivers** | 2021 | 114           | 112            | 115            |
| **Rivers** | 2018 | 152           | 150            | 153            |
| **Lakes**  | 2024 | 131           | 129            | 132            |
| **Lakes**  | 2021 | 92            | 91             | 94             |

: Unscaled values for total nitrogen (in µg/L) in rivers and lakes for Norway in different years {.striped .hover}

&nbsp;

| Ecosystem  | Region     | Best estimate | Lower quartile | Upper quartile |
|:----------:|:-----------|--------------:|---------------:|---------------:|
| **Rivers** | Østlandet  | 217           | 211            | 222            |
| **Rivers** | Sørlandet  | 198           | 192            | 204            |
| **Rivers** | Vestlandet | 129           | 126            | 133            |
| **Rivers** | Midt-Norge | 132           | 129            | 136            |
| **Rivers** | Nord-Norge | 76            | 75             | 78             |
| **Lakes**  | Østlandet  | 208           | 203            | 213            |
| **Lakes**  | Sørlandet  | 111           | 109            | 114            |
| **Lakes**  | Vestlandet | 83            | 81             | 85             |
| **Lakes**  | Midt-Norge | 137           | 133            | 141            |
| **Lakes**  | Nord-Norge | 101           | 99             | 104            |

: Unscaled values for total nitrogen (in µg/L) in rivers and lakes for regions of Norway in 2024 {.striped .hover}

<!--# 
Repeat the final results here. Typically this is a map or table of indicator values.

This is typically where people will harvest data from, so make sure to include all relevant output here, but don't clutter this section with too much output either.
-->

<!--# 
## 11. Export file

Optional: Display the code (don't execute it) or the workflow for exporting the indicator values to file. Ideally the indicator values are exported as a georeferenced shape or raster file with indicators values, reference values and errors. You can also chose to export the raw (un-normalised or unscaled variable) as a seperate product. You should not save large sptaial output data on GitHub. You can use eval=FALSE to avoid code from being executed (example below - delete if not relevant) 
-->

```{r export}
#| eval: false
```
