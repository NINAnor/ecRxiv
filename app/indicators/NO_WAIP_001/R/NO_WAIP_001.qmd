---
title: "AIP (acidification index periphyton)"
subtitle: |
  [NO_WAIP_001]
indicatorID: NO_WAIP_001
indicatorName: 
  - AIP (acidification index periphyton)
folderName: NO_WAIP_001
country: Norway
continent: Europe
ECT: A2 Chemical State characteristics
Realm: 
  - Freshwater (F)
Biome: 
  - F1 Rivers and streams biome
Ecosystem: 
  - F1.3 Freeze-thaw streams
yearAdded: 2025
yearLastUpdate: 2025
status: complete
Version: "002.000"
VersionComment: Improved functions, revised structure, updated with 2024 data
url: https://github.com/NINAnor/ecRxiv/tree/main/indicators/NO_WAIP_001
Normalised: Yes
SpatialAggregationPathway: Scale - Transform - Aggregate (length-weighted arithmetic mean) - Truncate
format: 
  html:
    embed-resources: true
    code-fold: true
    toc: true
    toc-title: Contents
    toc-depth: 3
    smooth-scroll: true
execute: 
  cache: true
author:
  - name: Hanno Sandvik
    email: hanno.sandvik@nina.no
    affiliations:
      - id: myID
        name: Norwegian Institute for Nature Research
AuthorList: Sandvik, H.  
date: November 28, 2025
data_availability: gold
code_reproducibility: silver
open_science_badge: silver
callout-icon: false
lightbox: true
css: ../../../style.css
code-links:
      - text: Add a review
        icon: github
        href: https://github.com/NINAnor/ecRxiv
hide: FALSE
---

<!--# This is a template for how to document the indicator analyses. Make sure also to not change the order, or modify, the headers, unless you really need to. This is because it easier to read if all the indicators are presented using the same layout. If there is one header where you don't have anything to write, just leave the header as is, and don't write anything below it. If you are providing code, be careful to annotate and comment on every step in the analysis. Before starting it is recommended to fill in as much as you can in the metadata file. This file will populate the initial table in your output.-->

<!--# Load all you dependencies here -->

```{r setup}
#| include: false
#| cache: false
library(knitr)
library(tidyverse)
library(kableExtra)
library(here)
library(anybadger)
library(yaml)
library(tibble)
library(conflicted)
# weird workarounds for cache issues
conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::lag)
conflicts_prefer(dplyr::select)
pull<-dplyr::pull

knitr::opts_chunk$set(echo = TRUE)

library(foreign)
library(sf)
library(readxl)
library(httr)
library(jsonlite)
library(sp)
```

```{r source}
#| echo: false
#| cache: false
source(here::here("_common.R"))
source(here::here("extract_yaml.R"))
```





<!--# The following parts are autogenerated. Do not edit. -->

::: {layout-ncol="5"}

```{r statusBadge}
#| echo: false
status_badge(as.character(st))
```

```{r versionBadge}
#| echo: false
version_badge(my_version_number = as.character(version[[1]]),
  folder_name = folder_name)
```

```{r dataBadge}
#| echo: false
data_badge(as.character(badges[[1]]))
```

```{r codeBadge}
#| echo: false
code_badge(as.character(badges[[2]]))
```

```{r openScienceBadge}
#| echo: false
open_science_badge(as.character(badges[[3]]))
```
::: 
 

> **Recommended citation**: `r paste(auth, " ", year, ". ", name, " (ID(s): ", folder_name, ") ", "v. ", version, ". ecRxiv: ", url, sep="")`



::: {.callout-tip collapse="true"}
## Metadata
```{r tbl-meta2}
#| tbl-cap: 'Indicator metadata'
#| echo: false
#| warning: false
meta |>
  dplyr::filter(Variable %in% c(
    "Indicator ID",
    "Indicator Name",
    "Continent",
    "Country",
    "Ecosystem Condition Typology Class", 
    "Realm",
    "Biome",
    "Ecosystem",
    "Year added", 
    "Last update",
    "Version",
    "Version comment",
    "Normalised",
    "Spatial aggregation pathway")) |>   
  kable()

```
:::

::: {.callout-tip collapse="true"}

## Log

<!--# Update this logg with short messages for each update -->
- 22 Apr 2025 - Version 001.000 started: first complete version
- 02 May 2025 - Version 001.000 submitted to review
- 06 May 2025 - Version 001.000 revised and ready for publication
- 08 Sep 2025 - Version 002.000 started: improved functions, revised structure, updated with 2024 data
- 28 Nov 2025 - Version 002.000 submitted to review
:::


<hr />

<!--# Document you work below.  -->

## 1. Summary

1. **Background and rationale**:
River ecosystems are negatively affected by anthropogenic activities that change the chemical composition of the water, such as acidification due to air pollution and subsequent acidic precipitation. 
AIP (acidification index periphyton) is a measure of the sensitivity of *periphyton* to acidification, where "periphyton" is an umbrella term for algae growing on submerged surfaces. 
AIP is estimated by calculating the average sensitivity scores of the periphyton species sampled in a given location ([Schneider & Lindstrøm 2009](#sch09)). 
Rivers characterised by periphyton communities with low sensitivity to acidic conditions indicate a functional shift towards more disturbed ecosystems.
In this way, AIP detects river acidification. 
<!-- What does the metric represent? Why is this relevant for describing ecosystem condition in this ecosystem?
What are the main anthropogenic impact factors? -->
2. **Methods**:
AIP is one of the indicators that is measured and reported in connection with the [*Water Framework Directive*](#wfd) (hereafter **WFD**). 
In Norway, the WFD is implemented by means of [*Vannforskriften*](#vannf), and relevant indicators ("parameters", in WFD terminology) are described in national guidelines ([DGVF 2025](#veil2)). 
The data collected are archived and made available in the [*Vannmiljø*](#vannm) database.
Estimation follows a dataflow that has been described and documented earlier ([Sandvik 2019](#san19), [Sandvik 2025](#san25)) and that consists of the following steps:
    * Removing measurements that do not fulfil the requirements for the specific indicator.
    * Identifying the water body for each measurement.
    * Scaling and transforming measurements to "modified Ecological Quality Ratios" according to the normative definitions of "ecological status" categories provided by the WFD.
    * Fitting a linear model to the measurements, with explanatory variables being typology factors of the water bodies, reporting periods, and surveillance activities.
    * Extrapolating mEQR values to water bodies that lack data, based on the model fitted.
    * Using simulations to estimate confidence and prediction intervals.
    * Aggregating estimates geographically using area-weighted averages.
    * Truncating the values obtained to the interval from 0 to 1.
<!-- What kind of data is used? How is the data customized (modified, estimated, integrated) to fit its purpose as an indicator? -->
3. **Interpretation**:
An indicator value of 1 signifies a condition where there is little or no human impact on the water body. 
Values decreasing toward zero reflect negative ecological change, specifically a decrease of acid-sensitive periphyton species due to acidification.
<!-- Add a very short description of how the indicator values should be interpreted. Here's an example for a bumblebee indicator: An indicator value of 1 signifies an intact bumblebee community. Values decreasing toward zero reflect negative ecological change, specifically the decline of species expected to be present. This metric does not account for potentially positive changes, such as increases in species' abundance or the arrival of new species. Tip: Add text on the line directly following the subheader, and don't introduce blank lines. This way the whole paragraph renders as a block quote. -->
4. **Results and development needs**:
The indicator is ready for use. 
The value for 2024 indicates that the ecosystem is in the reference condition for AIP.
<!-- Briefly, what does the indicator say about the ecosystem condition. What is the current status of  the metric (can it be used or is it still in development), and what immediate tasks remain to improve the indicator or to make the indicator operational -->


## 2. About the underlying data

WFD data in Norway are collected in a common database called [*Vannmiljø*](#vannm), which is maintained by the [Norwegian Environment Agency](https://www.miljodirektoratet.no/). 
This database contains information on all *measurements* taken in connection with the WFD ("registrations") as well as all *locations* at which measurements are taken ("water localities"). 
Each water locality is assigned to a *water body*. 
Information on water bodies can be retrieved from two other databases: the typology of water bodies is available from [*Vann-nett*](#vannn), whereas a geospatial dataset can be [downloaded](https://karteksport.miljodirektoratet.no/) from the Norwegian Environment Agency.

<!--# Describe the data you have used in more detail, it's origin, biases, availability ect.-->

### 2.1 Spatial and temporal resolution and extent

The **spatial** resolution of WFD indicators is on the level of *water bodies*. 
The WFD defines a water body (specifically a "body of surface water") as "a discrete and significant element of surface water such as a lake, a reservoir, a stream, river or canal, [or] part of a stream, river or canal" (WFD, Article 2, paragraph 10; cf. *Vannforskriften* §&nbsp;3, letter a; for implementation, see [DGVF 2018](#veil1), ch.&nbsp;2).

There is no specific **temporal** resolution, as measurements of WFD indicators are reported sporadically. 
Some water bodies are sampled regularly (e.g., every fifth year). 
For most water bodies, however, no such fixed surveillance schemes exist. 
Still, the total amount of measurements for many WFD indicators is sufficient to estimate annual values that are spatially aggregated to the national and regional level.

A specific requirement for AIP is that measurements are taken between June and October ([DGVF 2025](#veil2)).

<!--# Describe the temporal and spatial resolution and extent of the data used -->

### 2.2 Sampling design

WFD indicators are mainly measured opportunistically, e.g. when and where some authority has a need to check whether a water body fulfils the management objective of the WFD. 
However, a subset of the measurements is taken systematically, e.g. repeated measurements in a sample of water bodies that have been selected following certain criteria.

This sampling procedure implies that the representativeness of the sampled water bodies for the non-sampled water bodies is essentially unknown. 
A specific concern is that quite some WFD measurements are taken *precisely because the sampled water body is known or assumed to be unrepresentative*. 
The main reasons are the following:

* Some water bodies are sampled because it is known or suspected that they do not fulfil the normative objective that X > X~60~ (in order to justify and design measures to improve ecological condition and, later, to evaluate the effect of the measures taken).
* Some water bodies are sampled because they are regarded as reference water bodies, i.e. assumed to be in, or very close to, the reference condition.

<!-- How was the data sampled? Describe potential sampling biases -->

### 2.3 Original units

AIP is calculated as a dimensionless score with possible values between 5.13 and 7.42, where the sensitivity of periphyton species to acidification increases with increasing scores.
The score of a species represents the average pH at the sites where the species occurs ([Schneider & Lindstrøm 2009](#sch09)). 
However, in connection with the WFD, values are normally reported as "normalised ecological quality ratios" (nEQR) between 0 and 1, which correspond to *indicator* values sensu [SEEA&nbsp;EA](#seeaea).

<!--# What are the original units for the most relevant  variables in the data-->

### 2.4 Instructions for citing, using and accessing data

For suggestions on how to cite the datasets, see [*Vannmiljø*](#vannm), [*Karteksport*](#kartx), and [*Vann-nett*](#vannn). 
All data used are publicly available. 
However, with the exception of *Vannmiljø*, they are not accessible via an API but need to be downloaded manually. 
Some required files are currently unavailable from *Vann-nett* (temporarily so, it seems); they are therefore read from a previous *Vann-nett* download, which is archived in the GitHub repo [WFD2ECA](https://github.com/NINAnor/WFD2ECA/). 
For further details, see [chapter&nbsp;7](#import-and-prepare-datasets) below.

<!--# Is the data openly available? If not, how can one access it? What are the key references to the datasets?   -->


## 3. Indicator properties

AIP has the ID **90** in the metadata table for ecological condition variables for use in Norway ([Czúcz et al. 2023](#czu23)).
The abbreviation used in the *Vannmiljø* database is **AIP** (this is needed for downloading the correct dataset).

```{r}
# Vannmiljø abbreviation and title of the indicator
indikator <- tittel <- "AIP"
# The relevant surface water category (**R**iver, **L**ake and/or **C**oast) 
vannkategori <- "R"
```

### 3.1 Ecosystem Condition Typology Class (ECT)

The ECT of AIP is **A2** (chemical state) because the indicator measures the effect of acidification on the periphyton community.

**B1** (compositional state) may be regarded as a *secondary* ECT class of AIP, as AIP is estimated based on the set of periphyton species present in the locality sampled, which is a measure of *biodiversity*.

<!--# 
Describe the rationale for assigning the indicator to the ECT class. See https://oneecosystem.pensoft.net/article/58218/
This doesnt need to be very long. Maybe just a single sentence. 
-->

#### 3.1.1 Other condition typologies

In the Norwegian classification of ecological characteristics (*økologiske egenskaper*) according to Nybø & Evju ([2017](#nyb17), p.&nbsp;35), the indicator represents **abiotic conditions** (*abiotiske forhold*).

In the WFD's distinction between *quality elements*, the indicator represents the **aquatic flora** (WFD, Annex&nbsp;V).

<!--# Optional: Add text about other spesific standards, e.g. national standards, and how the indicator relates to these -->

### 3.2 Ecosystem condition characteristic

Intact ecosystems are characterised by being chemically neutral or slightly alkaline, and AIP represents the acidification of rivers.

<!--# 
Describe the ecosystem condition characteristic represented in the indicator. See 10.3897/oneeco.6.e58218 for information on what these characteristics might be.
For example, and indicator called 'Trenching in mires' could be made to represent an ecosystem characteristic 'Intact hydrology'. The term 'characteristic' is used similar to the term 'criteria' in Multiple Criteria Decition Making.  
-->

### 3.3 Collinearities with other indicators

AIP is correlated to [water pH](https://github.com/NINAnor/ecRxiv/tree/main/indicators/NO_WPHX_001_002) and may be broadly correlated to other measures of river acidification, specifically [RAMI](https://github.com/NINAnor/ecRxiv/tree/main/indicators/NO_WAMI_001), [ANC](https://github.com/NINAnor/ecRxiv/tree/main/indicators/NO_WANC_001_002) and [labile aluminium](https://github.com/NINAnor/ecRxiv/tree/main/indicators/NO_WLAL_001_002).

<!--# Describe known collinearities with other metrices (indicators or variables) that could become problematic if they were also included in the same Ecosystem Condition Assessment as the indicator described here. -->

### 3.4 Impact factors

AIP is affected by acidification, which usually is the result of long distance pollution (air pollution with sulfur dioxide, nitrogen oxide etc., and subsequent acidic precipitation).

<!--# Describe the main natural and anthropogenic factors that affecst the metric -->

### 3.5 Spatial aggregation

According to the WFD and DGVF ([2025](#veil2)), measurements of WFD variables are transformed into so-called nEQR values ("normalised Ecological Quality Ratios") between 0 and 1, which correspond to indicator values sensu [SEEA&nbsp;EA](#seeaea) (see [section&nbsp;4.2](#reference-levels)). 
In a WFD context, this is normally done using the following steps:

1. *Truncation.* Variable values are truncated, where measurements that are poorer than X~0~ are set to X~0~, and measurements that are better than X~100~ are set to X~100~.
2. *Scaling.* The truncated variable values are linearly scaled so that X~0~ becomes 0 and X~100~ becomes 1. The resulting indicator values are referred to as **EQR**s ("Ecological Quality Ratios").
3. *Transformation.* EQR values are transformed in a stepwise-linear manner, so that the indicator values 0.2, 0.4, 0.6 and 0.8 correspond to the thresholds between the normative definitions of "bad", "poor", "moderate", "good" and "high" ecological status according to the WFD. The resulting indicator values are referred to as **nEQR**s ("normalised EQRs").
4. *Summary statistics.* Instead of spatial aggregation, the proportion of water bodies fulfilling the normative objective of the WFD is calculated.

Truncation, however, removes information about variation in ecosystem condition that is important for estimating (modelling and extrapolating) the indicator value and its uncertainty. 
Therefore, the dataflow from WFD to an Ecosystem Condition Account should be based on values that are *scaled and transformed but not truncated*.
This is implemented in the current context by modifying the order of the steps from truncation--scaling--transformation--statistics to scaling--transformation--aggregation--truncation (following [Sandvik 2019](#san19): pp.&nbsp;13--15, [Sandvik 2025](#san25)):

1. *Scaling.* The *un*truncated variable values are linearly scaled so that X~0~ becomes 0 and X~100~ becomes 1. Note that the resulting values may be negative (if X is poorer than X~0~) or larger than 1 (if X is better than X~100~).
2. *Transformation.* The scaled values are transformed in a stepwise-linear manner in accordance with the [reference levels](#reference-levels) defined by the WFD. The resulting indicator values are here referred to as **mEQR**s ("modified EQRs"). This step requires an adjustment in cases were the minimum and/or maximum values of X can be much lower or higher than X~0~ or X~100~. The approach chosen here ensures that no indicator value can be below &minus;0.2 or above 1.2 (described, in Norwegian, [here](https://github.com/NINAnor/WFD2ECA/blob/main/forklar/asympEQR.md)).
3. *Aggregration.* Indicator values for the specific water bodies are spatially aggregated using model-based extrapolation to water bodies for which no measurements are available, followed by size-weighted arithmetic averages across all relevant water bodies (where "size" is the *area* of lake water bodies and the *length* of river water bodies).
4. *Truncation.* When mEQR values are truncated in a final step, they become identical to nEQR values. However, truncation is here done only after the spatial aggregation of the modelled and simulated values.

<!-- Describe in word the same aggregation pathway presented in the metadata.xlsx. If you have scaled against the reference value, it is especially important to know if you did any avergaing or summations etc. beforehand. An example text for a rather simple case could be: "The variable is scaled at the initial polygon level and the point estimate is a area-weighted arithmetic mean of all polygins. There is no transformation, and truncation is not needed as the indicator becomes naturally bound between 0 and 1". -->


## 4. Reference condition and levels

### 4.1 Reference condition

The WFD defines the reference condition of a water body as "the condition of a quality element where there is little or no human impact on the water body. The reference condition is therefore also referred to as the natural condition" ([DGVF 2025](#veil2)).

Reference conditions may be specific to certain water-body types. 
Water bodies judged to be in the reference condition are referred to as *reference water bodies*.

<!--# Define the reference condition (or refer to where it is defined). Note the distinction between reference condition and reference levels 10.3897/oneeco.5.e58216  -->

### 4.2 Reference levels

According to the WFD, reference levels are defined for X~0~, X~20~, X~40~, X~60~, X~80~, and X~100~. 
These are used to classify the "ecological status" of water bodies as "bad" (X~0~ &le; X &le; X~20~), "poor" (X~20~ < X &le; X~40~), "moderate" (X~40~ < X &le; X~60~), "good" (X~60~ < X &le; X~80~), and "high" (X~80~ < X &le; X~100~). 
The WFD enforces the environmental *objectives* that water bodies shall not have an indicator value below X~60~, and that water bodies already obtaining an indicator value above X~80~ shall not drop below this threshold (WFD, Article&nbsp;4; cf. *Vannforskriften* §&nbsp;4).
The WFD (Annex&nbsp;V, section&nbsp;1.2) provides the following normative definition of "high status": 
"The values of the biological quality elements for the surface water body reflect those normally associated with that type under undisturbed conditions, and show no, or only very minor, evidence of distortion."
An approach used for many WFD indicators, including this one, is to define X~100~ as the median of the variable values measured in reference water bodies.

Reference levels for AIP are provided in Table 5.3a of DGVF ([2025](#veil2)). 
A more detailed description of the calculation of AIP can be found in Table V5.1.2. 

According to these tables, possible variable values range from 5.13 to 7.42, corresponding to a continuum from maximum acidification tolerance to maximum acidification sensitivity of the periphyton sampled. 

<!--# 
If relevant (i.e. if you have normalised a variable), describe the reference levels used to normalise the variable. 

Use the terminology where X~0~ refers to the reference level (the variable value) denoting the worst possible condition; X~100~denotes the optimum or best possible condition; and X~*n*~, where in is between 0 and 100, denotes any other anchoring points linking the variable scale to the indicator scale (e.g. the threshold value between good and bad condition X~60^). 

Why was the current option chosen and how were the reference levels quantified? If the reference values are calculated as part of the analyses further down, please repeat the main information here.
-->

#### 4.2.1 Spatial resolution and validity

The spatial resolution of WFD reference levels is the water body. 
Reference levels of AIP differ between river water body types. 
Depending on the natural alkalinity (calcium concentration) and total organic carbon (TOC), river water bodies are grouped in four categories, each with their own set of reference levels ([DGVF 2025](#veil2), Table 5.3a).

<!--# 
Describe the spatial resolution of the reference levels. E.g. is it defined as a fixed value for all areas, or does it vary. Also, at what spatial scale are the reference levels valid? For example, if the reference levels have a regional resolution (varies between regions), it might mean that it is only valid and correct to use for normalising local variable values that are first aggregated to regional scale. However, sometimes the reference levels are insensitive to this and can be used to scale variables at the local (e.g. plot) scale. 
-->


## 5. Uncertainties

### 5.1 General uncertainties

The main uncertainty for spatially aggregated values of the indicator is *sampling error*. 
Measurements of variable values are only sampled in a small fraction of all relevant water bodies.

A further uncertainty pertains to the *reference levels*, which are not equally well studied in all water body types. 
Whereas they are well-founded in common water body types, reference levels may not be entirely representative for rarer ones. 

<!--# Describe the main reasons why you might not trust 100% the final value to represent the given ecosystem characteristic for the give ecosystem type. What aspects of this condition metric are most sensitive to subjective decitions? Is the spatial sampling sufficient? Does the choice of modeling framework affect the values? Is the metric relevant do describe ecosystem condition for the give ecosystem type?  -->

### 5.2 Reported uncertainties

The uncertainties reported are inferential, i.e. they refer to the uncertainty around the point estimates. 
Quartiles (or, if needed, other error estimates) are obtained by drawing random numbers from the confidence intervals for water bodies that have been measured, and from the prediction intervals for water bodies that have been extrapolated. 

Extrapolation is based on a model fitted to the data.
This model also attempts to correct for sampling bias (see [section&nbsp;2.2](#sampling-design)) by weighting measurements by the "surveillance activity" (*overvåkingsaktivitet*) during which they have been sampled. 
Scores between &minus;3 and +3 have been assigned to each surveillance activity, where the sign indicates the direction of the deviation (poorer or better than a randomly chosen water body), and the absolute value is an estimate of the magnitude of the bias. 
The approach has been described (in Norwegian) by Sandvik ([2019](#san19): pp.&nbsp;17--19) and extended by Framstad et al. ([2023](#fra23): pp.&nbsp;121--122).

<!-- Describe the nature of the errors you (hopefully) provide alongside the point estimate for the condition metric. It is especially important to clarify if the errors are inferential (referring to the uncertainty of the point estimate) or descriptive (referreing to the data itself). Here' an example text: "What we report as uncertainties in @tbl-finalTable are inferential and refer to the uncertainty around the point estimates. It does not directly describe variation in the data itself. 
However, the variation in the mean is defined by the spatial variation only, and quartiles are obtained by bootstrapping the set of localities within a region, and calculating the indicator for each of 9999 such samples".   -->


## 6. References

<span id="czu23">Czúcz B, Sandvik H, Framstad E & Schartau AK.</span> 2023. Metadata for ecological condition variables for use in Norway, version 1.0. [[doi:10.5281/zenodo.10187828](https://doi.org/10.5281/zenodo.10187828)]

<span id="veil1">DGVF [Direktoratsgruppa for vannforvaltning].</span> 2018. *Veileder 1:2018 Karakterisering. Metodikk for å karakterisere og vurdere miljømålsoppnåelse etter vannforskriftens § 15.* Miljødirektoratet, Trondheim. <https://www.vannportalen.no/veiledere/veileder-12018-karakterisering-metodikk-fora-karakterisere-og-vurdere-miljooppnaelse-etter-vannforskriften--15/>

<span id="veil2">DGVF [Direktoratsgruppa for vannforvaltning].</span> 2025. *Veileder for klassifisering av miljøtilstand i kyst- og ferskvann* [version of 28 Jan 2025]. Vannportalen. <https://www.vannportalen.no/veiledere/klassifiseringsveileder/>

<span id="fra23">Framstad E, Czúcz B, Schartau AK, Simensen T, Nybø S & Sandvik H. 2023.</span> Naturregnskap og økologisk tilstand: Samsvar mellom fagsystemet for økologisk tilstand, vannforskriften, FNs rammeverk og EUs forslag til naturregnskap. *NINA Rapp* **2327**: 1--122. [[hdl:11250/3104185](https://hdl.handle.net/11250/3104185)]

<span id="vannm">Miljødirektoratet.</span> 2025. *Vannmiljø*. <https://vannmiljo.miljodirektoratet.no> (manual download) and <https://vannmiljowebapi.miljodirektoratet.no/swagger/ui/index#/> (API)

<span id="kartx">Miljødirektoratet.</span> 2025. *Karteksport: Vannforekomster*. <https://karteksport.miljodirektoratet.no>

<span id="vannn">Miljødirektoratet.</span> 2025. *Vann-nett*. <https://vann-nett.no/>

<span id="nyb17">Nybø S & Evju M (eds).</span> 2017. *Fagsystem for fastsetting av god økologisk tilstand. Forslag fra et ekspertråd.* Klima- og miljødepartementet, Oslo. <https://www.regjeringen.no/id2558481/>

<span id="san19">Sandvik H.</span> 2019. Ferskvann i vannforskriften og naturindeksen. Forslag til samordning og dataflyt. *NINA Rapp* **1723**: 1--38. [[hdl:11250/2631056](http://hdl.handle.net/11250/2631056)]

<span id="san25">Sandvik H.</span> 2025. WFD2ECA: Dataflyt fra vannforskriften til økologisk tilstandsregnskap og naturindeks, version 2.1. <https://github.com/NINAnor/WFD2ECA> [[doi:10.5281/zenodo.10278000](https://doi.org/10.5281/zenodo.10278000)]

<span id="sch09">Schneider S & Lindstrøm E-A.</span> 2009. Bioindication in Norwegian rivers using non-diatomaceous benthic algae: the acidification index periphyton (AIP). *Ecol Indic* **9**: 1206--1211. [[doi:10.1016/j.ecolind.2009.02.008](https://doi.org/10.1016/j.ecolind.2009.02.008)]

<span id="seeaea">**SEEA EA**:</span> United Nations et al. 2024. *System of Environmental-Economic Accounting -- Ecosystem Accounting.* UN, New York. <https://seea.un.org/ecosystem-accounting>

<span id="vannf">**Vannforskriften**.</span> 2006. Forskrift om rammer for vannforvaltningen. *Nor Lovtid I* **2006**: 2004--2034. [[FOR-2006-12-15-1446](https://lovdata.no/dokument/SF/forskrift/2006-12-15-1446)]

<span id="wfd">**WFD**:</span> EU. 2000. Directive 2000/60/EC of the European Parliament and of the Council of 23 October 2000 establishing a framework for Community action in the field of water policy. *Off J EU L* **43** (327): 1--72. [[CELEX:32000L0060](http://eur-lex.europa.eu/LexUriServ/LexUriServ.do?uri=CELEX:32000L0060:en:NOT)]
  
<!--# You can add references manually or use a citation manager and add intext citations as with crossreferencing and hyperlinks. See https://quarto.org/docs/authoring/footnotes-and-citations.html -->


## 7. Import and prepare datasets

<!--# Describe the unique datasets seperately under seperate headers (Dataset A, Dataset B, etc.-->

### 7.1 WFD2ECA

The dataflow used here has been described in the GitHub repository [WFD2ECA](https://github.com/NINAnor/WFD2ECA/) ([Sandvik 2025](#san25)). 
We start by downloading the functions and data files from archived version 2.1 of that repo.

```{r}
if(!file.exists("../data/VF.RData")) {
  download.file("https://zenodo.org/records/17702361/files/NINAnor/WFD2ECA-v2.1.zip",
                "../data/WFD2ECA.zip")
  folder <- "../data/WFD2ECA"
  unzip("../data/WFD2ECA.zip", exdir = folder)
  while (length(list.files(folder)) == 1) {
    folder <- paste0(folder, "/", list.files(folder))
  }
  whichDataFile <- c(
    "fnr.xlsx",
    "knr.xlsx",
    #"navnNVEl.csv",
    "navnVL.csv",
    "navnVM.csv",
    "navnVN.csv",
    #"NVE.RData",
    "Norge.map",
    paste0("V-", vannkategori, ".csv"),
    "VF.RData",
    "VM-aktiv.xlsx",
    "VM-param.xlsx"
  )
  dummy <- file.copy(from = paste0(folder, "/data/", whichDataFile),
                     to   = "../data/",
                     overwrite = FALSE)
  dummy <- file.copy(from = paste0(folder,
                                   "/klassegr/klassegrenser_",
                                   indikator, 
                                   ".xlsx"),
                     to   = "../data/",
                     overwrite = FALSE)
  dummy <- file.copy(from = list.files(paste0(folder, "/R/"), full.names = TRUE),
                     to   = ".",
                     overwrite = FALSE)
  dummy <- file.remove("../data/WFD2ECA.zip")
  unlink("../data/WFD2ECA", recursive = TRUE)
}
```

Next, we load the functions contained in that repo.

```{r}
source("Funksjon.R")
for (filnavn in list.files(".", full.names = TRUE)) {
  if (substr(filnavn, nchar(filnavn), nchar(filnavn)) %=% "R") {
    source(filnavn)
  }
}
```

Among the data files downloaded, there are the reference levels of the indicator for different water body types ...

```{r}
head(as.data.frame(read_xlsx("../data/klassegrenser_" %+% indikator %+% ".xlsx", col_types = "text")))
```

... and a list of surveillance activities with their "bias score" (`skaar`).

```{r}
head(as.data.frame(read_xlsx("../data/VM-aktiv.xlsx", col_types = "text")))
```

### 7.2 Vannmiljø

*Vannmiljø* is a database maintained by the [Norwegian Environment Agency](https://www.miljodirektoratet.no/) that is used to collect registrations related to ecological condition of water according to the WFD. 
This database contains information on all *measurements* taken in connection with the WFD ("registrations") as well as all *locations* at which measurements are taken ("water localities"). 
Other information available from *Vannmiljø* includes lists of WFD variables and indicators ("parameters"), of surveillance activities, of measurement units used, of species recorded etc. 

The database has long been available for manual download via [https://vannmiljo.miljodirektoratet.no](https://vannmiljo.miljodirektoratet.no/). 
Recently, a subset of the data have also been made available via an [API](https://vannmiljowebapi.miljodirektoratet.no/swagger/ui/index#/). 
For the time being, one still needs to use the manual download for complete results. 
For illustration purposes, however, we use the *Vannmiljø* API here.

First we read the measurements of the specified indicator from *Vannmiljø*. 
(The following code reads data from the API. 
To read data from a manual download, replace "indicator" by the file name of the spreadsheet.)

```{r}
DATA <- lesMaalinger(indikator)
```

The output informs us that the operation was successful and how many registrations have been read. 
This is how the dataset looks like:

```{r}
{
  D <- DATA[1:12, ]
  for (i in 1:ncol(D)) D[, i] <- substr(D[, i], 1, 10)
  for (i in c(3, 4)) D[, i] <- D[, i] %+% "..."
  print(head(D))
  rm(D)
}
```

An explanation of the columns (in Norwegian) is given [elsewhere](https://github.com/NINAnor/WFD2ECA/blob/main/forklar/lesMaalinger.md#funksjonsverdi).

A list of water localities (*vannlokaliteter*) is likewise read from *Vannmiljø*. 
(The following code reads data from the API. 
To read data from a manual download, ensure that the spreadsheet is named "VL-L.xlsx" for lakes and "VL-R.xlsx" for rivers, and set the argument `API = FALSE`.)

```{r}
VL <- lesVannlokaliteter(API = TRUE)
```

The output informs us that the operation was successful and how many water localities there are.
This is how the dataset looks like:

```{r}
head(VL)
```

The columns are the water locality ID, code and name, the ID of its water body, its surface water category and UTM coordinates.

### 7.3 Water body locations

The subsequent [analyses](#analyses) need the *location* of each water body (*vannforekomst*).
A geospatial dataset with this information is publicly available, but it needs to be downloaded manually:

* Navigate to [https://karteksport.miljodirektoratet.no](https://karteksport.miljodirektoratet.no/).
* In the menu to the left of the map, tick "Vannforekomster" in the "Produkt" section ...
* ... and "Nasjonalt" in the "Definer område" section.
* Click "Neste".
* Provide your e-mail in the "Epost" box.
* Choose "ESRI Filgeodatabase (ESPG:4326)" in the "Format" box.
* Upon pressing "Send bestilling", a compressed geodatabase (gdb) will be sent to your e-mail.

The uncompressed geodatabase is needed for the analyses. 
It has to have the name "VF.gdb" and to be placed in the "data" folder in order to be recognised. 
(The [analyses](#analyses) use a cached version called "VF.RData", which is available via the WFD2ECA repo, see [section&nbsp;7.1](#wfd2eca).)

### 7.4 Vann-nett

In addition to the location, we need information on the *typology* of each water body. 
In WFD context, typology refers to a set of factors describing abiotic characteristics of the water bodies, such as altitude, size and alkalinity. 
This information is publicly available from a separate database called *Vann-nett* via the link [https://vann-nett.no/waterbodies/report](https://vann-nett.no/waterbodies/report). 

A spreadsheet workbook exported from *Vann-nett* is needed for the analyses. 
It has to have the name "V-L.csv" (for lakes) or "V-R.csv" (for rivers) in order to be recognised.

*(Note that Vann-nett has recently been upgraded. In the new version, typology factors are not included in the list of variables that are available for export. For the time being, water body typology thus has to be based on an export from the previous version of Vann-nett, which is no longer online. These previous exports are available via the WFD2ECA repo, see [section&nbsp;7.1](#wfd2eca). It is to be hoped that the relevant information will be made available in the new version soon.)* <!--# 
I have requested this information to be added. I hope that it is only a matter of time before it is available again. -->

With the necessary files in place, we can read the water body information.

```{r, eval=FALSE, echo=TRUE}
V <- lesVannforekomster(vannkategori)
```
```{r, eval=TRUE, echo=FALSE}
# The geodatabase is too huge for GitHub, so a cached version is used instead
V <- lesVannforekomster(vannkategori, CACHE = "VF.RData")
```

The output informs us of several adjustments made to the data, but that the operation was successful and how many water bodies (of the relevant surface water category) there are.
This is how the dataset looks like:

```{r}
head(V)
```

An explanation of the columns (in Norwegian) is given [elsewhere](https://github.com/NINAnor/WFD2ECA/blob/main/forklar/lesVannforekomster.md#funksjonsverdi).


## 8. Spatial units

Data (measurements) are assumed to be representative for their respective water bodies, which correspond to the Ecosystem Assets of freshwater ecosystems. 
The Ecosystem Accounting Area covered by the data is mainland Norway. 

<!--# 
Describe the spatial units that you rely on in your analyses. Highlight the spatial units (the resolution) that the indicator values should be interpretted at. Potential spatial delineation data should eb introduced under 7.1. Datasets. We recomend using the SEEA EA terminology opf Basic Spatial Units (BSU), Ecosystem Asses (EA) and Ecosystem Accounting Area (EAA). 
-->

## 9. Analyses

### 9.1 Inspection of the dataset

To take an initial look at the data, we can show the raw (unfiltered and unscaled) measurements on a map.

```{r}
#| lab: measurement-map
#| fig-cap: "Map of Norway with points for all water bodies in which the indicator has been recorded. Colour indicates the average unscaled variable value for the water body."

{
  xaxis <- seq(5, 7, 0.5)
  dig <- 1
  snudd <- FALSE
  
  ml <- V[which(V$id %in% 
               VL$id[which(VL$lokid %in% 
                         DATA$lokid[which(DATA$verdi %mellom% range(xaxis))])]), ]
  ml$maaling <- NA
  for (i in 1:nrow(ml)) {
    ml$maaling[i] <- mean(DATA$verdi[which(DATA$lokid %in% 
                                             VL$lokid[which(VL$id == ml$id[i])])])
  }
  z <- 2
  fjern <- c()
  while (length(which(ml$maaling < xaxis[z])) == 0) {
    fjern <- c(fjern, z - 1)
    z <- z + 1
  }
  z <- length(xaxis) - 1
  while (length(which(ml$maaling > xaxis[z])) == 0) {
    fjern <- c(fjern, z + 1)
    z <- z - 1
  }
  if (length(fjern)) xaxis <- xaxis[-fjern]
  if (snudd) xaxis <- rev(xaxis)
  xlim <- range(xaxis)
  ml$maaling <- sapply(sapply(ml$maaling, max, xlim[1]), min, xlim[2])
  ml <- ml[order(ml$maaling, decreasing = !snudd), ]
  
  load("../data/Norge.map")
  par(mai = rep(0, 4))
  plot(Norge.kontur, xlim = c(3.5, 31.5), ylim = c(57.5, 71.5), 
       xaxs = "i", yaxs = "i", asp = 2, col = grey(0.84), border = NA)
  points(ml$long, ml$lat, pch = 20, cex = 0.6, col = if (snudd)
         farve(ml$maaling, xlim[2], xlim[1]) else 
         farve(ml$maaling, xlim[1], xlim[2]))
  text(6, 70, tittel, cex = 1.5, font = 2)
  for (i in seq(0, 0.999, 0.001)) {
    rect(24, 59+i*8, 26, 59+(i+0.001)*8, border = NA,
         col = if (snudd) farve(i, 1, 0) else farve(i, 0, 1))
  }
  rect(24, 59, 26, 67, lwd = 2)
  for (i in xaxis) {
    lines(c(24.0,23.6), rep(59 + 8 * (i-xlim[1]) / (xlim[2]-xlim[1]), 2), lwd=2)
  }
  text(23.6, 59 + 8 * (xaxis - xlim[1]) / (xlim[2] - xlim[1]), 
       erstatt(formatC((xaxis), dig, format = "f"), "-", "−"), pos = 2)
  if (length(unique(DATA$enhet)) %=% 1 & 
             unique(DATA$enhet) %!=% "3" & exists("Enheter")) {
    text(25, 58.5, Enheter[which(Enheter[, 1] == unique(DATA$enhet)), 2])
  }
}
```

### 9.2 Calculating mEQRs using reference levels

Following the description in [section&nbsp;3.5](#spatial-aggregation), measurements need to be transformed into mEQR values. 
Let us have closer look at the reference levels of the indicator (which are given in [DGVF 2025](#veil2)).

```{r}
klassegrenser <- hentKlassegrenser("../data/klassegrenser_" %+% indikator %+% ".xlsx")
if (nrow(klassegrenser) > 1) {
  m <- matrix(0, 8, 2, dimnames = list(
    c("Pessimum:", "Range of X_" %+% seq(0, 100, 20) %+% ":", "Optimum:"), 
    c("from", "to")))
  m[, 1] <- apply(klassegrenser, 2, min, na.rm = TRUE)
  m[, 2] <- apply(klassegrenser, 2, max, na.rm = TRUE)
  klassegrenser <- klassegrenser[which(!is.na(klassegrenser[, 1]))[1], ]
} else {
  m <- t(klassegrenser)
  dimnames(m) <- list(c("Pessim.", "X_0   =", "X_20  =", "X_40  =", "X_60  =",
                        "X_80  =", "X_100 =", "Optimum"), "")
}
print(m)
```

Since reference values differ between water body types, their ranges are shown above. 

The following graph shows the scaling and transformation of the indicator (using the WFD colour coding for ecological status classes).

```{r}
#| lab: meqr-fig
#| fig-cap: "Scaling and transformation from variable measurements to mEQR values"

xlim <- c(5, 7)
xaxis <- seq(5, 7, 0.5)
yaxis <- seq(-0.2, 1.2, 0.2)
x <- seq(5, 7.4, le = 1000)
y <- mEQR(x, klassegrenser)
forklar <- "Original variable values"
if (unique(DATA$enhet) %!=% "3" & exists("Enheter")) {
  forklar <- forklar %+% " (" %+% 
    Enheter[which(Enheter[, 1] == unique(DATA$enhet)), 2] %+% ")"
}
par(mai = c(0.96, 0.84, 0.84, 0.12))
plot(x, y, ty = "l", main = tittel,
     xlim = xlim,         xaxs = "r", xaxt = "n", xlab = forklar,
     ylim = c(-0.2, 1.2), yaxs = "r", yaxt = "n", ylab = "mEQR values",
     cex.main = 1.5, cex.lab = 1.2)
rect(xlim[1]-144,-0.4, xlim[2]+144, 0.0, col = rgb(0.0, 0.0, 0.0, 0.1), border = NA)
rect(xlim[1]-144, 0.0, xlim[2]+144, 0.2, col = rgb(1.0, 0.0, 0.0, 0.2), border = NA)
rect(xlim[1]-144, 0.2, xlim[2]+144, 0.4, col = rgb(1.0, 0.5, 0.0, 0.2), border = NA)
rect(xlim[1]-144, 0.4, xlim[2]+144, 0.6, col = rgb(1.0, 1.0, 0.0, 0.2), border = NA)
rect(xlim[1]-144, 0.6, xlim[2]+144, 0.8, col = rgb(0.0, 1.0, 0.0, 0.2), border = NA)
rect(xlim[1]-144, 0.8, xlim[2]+144, 1.0, col = rgb(0.0, 0.0, 1.0, 0.2), border = NA)
rect(xlim[1]-144, 1.0, xlim[2]+144, 1.4, col = rgb(0.5, 0.0, 1.0, 0.1), border = NA)
lines(c(xlim[1] - 144,    klassegrenser[7]), c(+1, 1), lwd = 1.5, col = "blue")
lines(c(klassegrenser[7], klassegrenser[7]), c(-1, 1), lwd = 1.5, col = "blue")
lines(c(xlim[1] - 144,    klassegrenser[2]), c(+0, 0), lwd = 1.5, col = "red")
lines(c(klassegrenser[2], klassegrenser[2]), c(-1, 0), lwd = 1.5, col = "red")
lines(x, y, lwd = 3)
axis(1, xaxis, c("5.0", 5.5, "6.0", 6.5, "7.0"), cex.axis = 0.9)
axis(2, yaxis, c("−0.2", "0.0", 0.2, 0.4, 0.6, 0.8, "1.0", 1.2), cex.axis = 0.9)
text(xlim[2], seq(0.1, 0.9, 0.2), c("bad", "poor", "moderate", "good", "high"), 
     pos = 2, offset = 0)
rf <- klassegrenser[7] > klassegrenser[2]
text(klassegrenser[2], -0.15, expression(X[0]),   pos=ifelse(rf, 4, 2), offset=0.3)
text(klassegrenser[7], -0.15, expression(X[100]), pos=ifelse(rf, 2, 4), offset=0.3)
```

Note that variable values may be substantially larger than X~100~ (blue line). 
Therefore, an asymptotic transformation is used for X > X~100~ in order to keep mEQR values below 1.2.
Variable values may also be somewhat smaller than X~0~ (red line).

### 9.3 Estimating the indicator values and their uncertainty

With the necessary files in place, the calculations can start. 
This is done using the function WFD2ECA ("Water Framework Directive to Ecosystem Condition Account"), which is [documented in the WFD2ECA repository](https://github.com/NINAnor/WFD2ECA/blob/main/forklar/dataflow.md) ([Sandvik 2025](#san25)).
The function produces summaries of the steps performed (for the time being, the information is provided in Norwegian only).

```{r, eval=FALSE, echo=TRUE}
utmating <- WFD2ECA(
  DATA = DATA,
  vannforekomster = V,
  vannlokaliteter = VL,
  parameter = indikator,
  vannkategori = vannkategori,
  iterasjoner = 1000,
  SEED = 479001600,
  vis = FALSE
)
```
```{r, eval=TRUE, echo=FALSE}
# To avoid messy output, the arguments "bredde" and "tell" are added
# This affects nothing but the layout
utmating <- WFD2ECA(
  DATA = DATA,
  vannforekomster = V,
  vannlokaliteter = VL,
  parameter = indikator,
  vannkategori = vannkategori,
  iterasjoner = 1000,
  SEED = 479001600,
  bredde = 90,
  vis = FALSE, # this simplifies/shortens the information about model fitting
  tell = FALSE
)
```

### 9.4 Summary of the output

The output is a list with one list element per geographic reporting level (i.e., in this case, one for the national and one for the regional level).
For each geographical unit on this level and each reporting year, the predicted value and the simulated values are saved.

```{r}
{
  ut <- utmating
  attributes(ut) <- attributes(ut)[1:3]
  # to simplify the output, most attributes are removed
  str(ut)
  rm(ut)
}
```

Note that the output consists of mEQR values, i.e. it may contain values below 0 or above 1. 
The values thus need to be truncated in a final step. 
They then correspond to nEQR values sensu WFD and indicator values sensu [SEEA&nbsp;EA](#seeaea).

```{r}
{
cat("Range of values prior to truncation (mEQR): " %+% 
    format(round(min(utmating$landsdel, na.rm=TRUE), 4), nsm=4, sci=FALSE) %+%
    " to " %+%
    format(round(max(utmating$landsdel, na.rm=TRUE), 4), nsm=4, sci=FALSE) %+% "\n")
tomrom <- ifelse(nchar(format(round(min(utmating$landsdel, na.rm=TRUE), 4), 
                              nsm=4, sci=FALSE)) %=% 7, " ", "")
utmating <- trunker(utmating)
cat("Range of values _after_  truncation (nEQR): " %+% tomrom %+%
    format(round(min(utmating$landsdel, na.rm=TRUE), 4), nsm=4, sci=FALSE) %+%
    " to " %+%
    format(round(max(utmating$landsdel, na.rm=TRUE), 4), nsm=4, sci=FALSE) %+% "\n")
}
```

The estimates and their confidence intervals may be summarised as tables.

```{r}
{
  kvantiler <- c(0.025, 0.25, 0.5, 0.75, 0.975)
  print(round(t(apply(utmating$Norge[  "Norge", , -1], 1, quantile, kvantiler)), 6)) 
  print(round(t(apply(utmating$landsdel[, "2024", -1], 1, quantile, kvantiler)), 6))
}
```

<!--# 
Use this header for documenting the analyses. Put code in separate code chunks, and annotate the code in between using normal text (i.e. between the chunks, and try to avoid too many hashed out comments inside the code chunks). Add subheaders as needed. 

Code folding is activated, meaning the code will be hidden by default in the html (one can click to expand it).

Caching is also activated (from the top YAML), meaning that rendering to html will be quicker the second time you do it. This will create a folder inside you project folder (called INDICATORID_cache). Sometimes caching created problems because some operations are not rerun when they should be rerun. Try deleting the cash folder and try again.
-->


## 10. Results

As reference values of AIP differ between water body types and the scaling function used is non-linear, aggregated averages of *unscaled* values (*variable* values sensu SEEA&nbsp;EA) are not informative. 
Therefore, this indicator is reported in terms of *scaled* values only (nEQR sensu WFD; *indicator* values sensu SEEA&nbsp;EA).

The results are here tabulated (a) for the whole country and different years, and (b) for regions in 2024. 
These estimates are based on a manual download from *Vannmiljø* and on 10,000 iterations and may therefore differ from the ones above.


| Year | Best estimate | Lower quartile | Upper quartile |
|:-----|:-------------:|:--------------:|:--------------:|
| 2024 | 1.000         | 1.000          | 1.000          |
| 2021 | 1.000         | 1.000          | 1.000          |
| 2018 | 1.000         | 1.000          | 1.000          |
| 2015 | 1.000         | 1.000          | 1.000          |
| 2012 | 1.000         | 1.000          | 1.000          |

: AIP indicator values for Norwegian rivers in different years {.striped .hover}

&nbsp;

| Region     | Best estimate | Lower quartile | Upper quartile |
|:-----------|:-------------:|:--------------:|:--------------:|
| Østlandet  | 1.000         | 1.000          | 1.000          |
| Sørlandet  | 1.000         | 1.000          | 1.000          |
| Vestlandet | 1.000         | 1.000          | 1.000          |
| Midt-Norge | 1.000         | 1.000          | 1.000          |
| Nord-Norge | 1.000         | 1.000          | 1.000          |

: AIP indicator values in rivers for regions of Norway in 2024 {.striped .hover}

<!--# 
Repeat the final results here. Typically this is a map or table of indicator values.

This is typically where people will harvest data from, so make sure to include all relevant output here, but don't clutter this section with too much output either.
-->

<!--# 
## 11. Export file

Optional: Display the code (don't execute it) or the workflow for exporting the indicator values to file. Ideally the indicator values are exported as a georeferenced shape or raster file with indicators values, reference values and errors. You can also chose to export the raw (un-normalised or unscaled variable) as a separate product. You should not save large sptaial output data on GitHub. You can use eval=FALSE to avoid code from being executed (example below - delete if not relevant) 

-->

```{r export}
#| eval: false
```

<!-- You can leave this last part as it is, unless you have a good reason to alter it. -->

::: {.callout-tip collapse="true"}
## Session Info

This information is mainly aimed at developers that need to recreate the R environment that produced the html.
Important note: this information is about the R session that was running when the html was rendered, and if some of the code chunks were not evaluated when the html was rendered, they may have been executed in a different environment.  

```{r sessionInfo}
#| echo: false
sessionInfo()
```

:::